<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Mark Sheet & Reporting System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; }
        /* Custom print styles for PDF reports */
        @media print {
            .no-print { display: none !important; }
            #main-content { padding: 0 !important; }
            #progress-report-print {
                width: 8.5in;
                min-height: 11in;
                margin: 0;
                padding: 0.5in;
                box-shadow: none;
                border: none;
            }
        }
    </style>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL APP STATE AND FIREBASE SETUP ---
        const INITIAL_DATA = {
            institution: {
                name: 'The Elite Academy',
                address: '123 Academic Way, Education City',
                logoUrl: 'https://placehold.co/100x40/4F46E5/ffffff?text=LOGO',
                examName: 'Annual Examinations 2024',
            },
            subjects: [
                { id: 'sub-math', name: 'Mathematics', maxMark: 100, isComposite: false, streamFilter: null, subSubjects: [] },
                { id: 'sub-phy', name: 'Physics', maxMark: 70, isComposite: false, streamFilter: 'Biology Science', subSubjects: [] },
                { id: 'sub-chem', name: 'Chemistry', maxMark: 70, isComposite: false, streamFilter: 'Biology Science', subSubjects: [] },
                { id: 'sub-cs', name: 'Computer Science Theory', maxMark: 70, isComposite: false, streamFilter: 'Computer Science', subSubjects: [] },
                { id: 'sub-acc', name: 'Accountancy', maxMark: 100, isComposite: false, streamFilter: 'Commerce', subSubjects: [] },
            ],
            students: [],
            nextStudentId: 1,
        };

        const GRADE_SCALE = [
            { threshold: 90, grade: 'A+', color: 'text-green-600', bgColor: 'bg-green-100' },
            { threshold: 80, grade: 'A', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 70, grade: 'B+', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 60, grade: 'B', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 50, grade: 'C+', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 40, grade: 'C', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 30, grade: 'D+', color: 'text-gray-900', bgColor: 'bg-gray-100' },
            { threshold: 0, grade: 'F', color: 'text-red-600', bgColor: 'bg-red-100' },
        ];
        
        const STREAMS = ['Computer Science', 'Biology Science', 'Commerce']; // Defined streams

        let appState = {
            data: INITIAL_DATA,
            rankedStudents: [],
            activeTab: 'marksheet', // 'marksheet', 'reports', 'settings'
            selectedStudentId: null,
            uploadMessage: '',
            isAuthReady: false,
            userId: null,
            db: null,
            auth: null,
            currentExamId: 'default-exam',
            examList: [],
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- IMPORTANT: REPLACE THIS CONFIGURATION IF RUNNING OUTSIDE OF CANVAS ---
        // You MUST replace the contents of this object with your actual Firebase Web App Configuration.
        const USER_PROVIDED_FIREBASE_CONFIG = {
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_AUTH_DOMAIN",
            // projectId: "YOUR_PROJECT_ID", // REQUIRED for Firestore
            // storageBucket: "YOUR_STORAGE_BUCKET",
            // messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            // appId: "YOUR_APP_ID"
        };
        // -------------------------------------------------------------------------
        
        // Prioritize Canvas config, fall back to user config
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : (Object.keys(USER_PROVIDED_FIREBASE_CONFIG).length > 0 ? USER_PROVIDED_FIREBASE_CONFIG : {});


        /** Utility: Converts a file object to a Base64 data URL */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        /** Utility: Grade Calculation */
        const calculateGrade = (score, maxMark) => {
            if (maxMark === 0) return { grade: 'N/A', color: 'text-gray-400', bgColor: 'bg-gray-50', percentage: '0.00' };
            const percentage = (score / maxMark) * 100;
            for (const scale of GRADE_SCALE) {
                if (percentage >= scale.threshold) {
                    return { grade: scale.grade, color: scale.color, bgColor: scale.bgColor, percentage: percentage.toFixed(2) };
                }
            }
            return { grade: 'F', color: 'text-red-600', bgColor: 'bg-red-100', percentage: percentage.toFixed(2) };
        };

        /** Utility: Ranking and Calculation Logic */
        const rankAndCalculate = (students, subjects) => {
            
            const calculatedStudents = students.map(student => {
                
                // 1. FILTER SUBJECTS relevant to the student's stream
                const studentSubjects = subjects.filter(subject => 
                    !subject.streamFilter || subject.streamFilter === student.stream
                );
                
                let studentTotalScore = 0;
                let studentTotalMaxMark = 0; // Max Mark calculated per student stream

                // Calculate subject scores/grades
                const newMarks = {};
                
                // Iterate over ALL subjects, but only count scores for relevant ones
                subjects.forEach(subject => { 
                    const isRelevant = !subject.streamFilter || subject.streamFilter === student.stream;
                    
                    let score = student.marks[subject.id]?.score || 0;
                    let subjectMaxMark = subject.maxMark;

                    // If composite, recalculate score from sub-subjects
                    if (subject.isComposite && subject.subSubjects.length > 0) {
                        subjectMaxMark = subject.subSubjects.reduce((sum, ss) => sum + ss.maxMark, 0);
                        // Also update the score based on sub-marks if present
                        score = subject.subSubjects.reduce((sum, ss) => sum + (student.marks[subject.id]?.subMarks?.[ss.name] || 0), 0);
                    }
                    
                    if (isRelevant) {
                        studentTotalScore += score;
                        studentTotalMaxMark += subjectMaxMark; // Add to student's specific Max Mark
                    }

                    // Store calculated grade/max mark (even for irrelevant subjects, for completeness in state)
                    newMarks[subject.id] = {
                        ...student.marks[subject.id],
                        score: score,
                        ...calculateGrade(score, subjectMaxMark),
                        maxMark: subjectMaxMark
                    };
                });
                
                const studentPercentage = studentTotalMaxMark > 0 ? (studentTotalScore / studentTotalMaxMark) * 100 : 0;

                return {
                    ...student,
                    marks: newMarks,
                    total: studentTotalScore,
                    percentage: studentPercentage.toFixed(2),
                    totalMaxMark: studentTotalMaxMark, // Store specific Max Mark
                };
            });

            // Sort and Rank
            calculatedStudents.sort((a, b) => b.total - a.total);
            let currentRank = 1;
            for (let i = 0; i < calculatedStudents.length; i++) {
                if (i > 0 && calculatedStudents[i].total < calculatedStudents[i - 1].total) {
                    currentRank = i + 1;
                }
                calculatedStudents[i].rank = currentRank;
            }

            return calculatedStudents;
        };

        /** Database: Save data to Firestore */
        const saveData = async (updates, refreshUI = true) => {
            // 1. Update State Optimistically
            const newData = { ...appState.data, ...updates };
            newData.students = rankAndCalculate(newData.students, newData.subjects);
            appState.data = newData;
            appState.rankedStudents = newData.students;
            if (refreshUI) render();

            // 2. Persist to Firestore
            if (appState.db && appState.userId && appState.isAuthReady) {
                try {
                    const docRef = doc(appState.db, `/artifacts/${appId}/users/${appState.userId}/mark_sheets`, appState.currentExamId);
                    await setDoc(docRef, newData, { merge: true });
                    console.log("Data saved successfully!");
                } catch (e) {
                    console.error("Error saving document: ", e);
                }
            }
        };

        /** Database: Switch Exam */
        window.switchExam = (examId) => {
            appState.currentExamId = examId;
            // The onSnapshot listener will automatically load the new data
            if (appState.db && appState.userId) {
                attachDataListener();
            } else {
                 appState.data = INITIAL_DATA;
                 render();
            }
        };

        /** Database: Attach Real-Time Listener */
        const attachDataListener = () => {
            if (!appState.db || !appState.userId) return;

            const dataDocRef = doc(appState.db, `/artifacts/${appId}/users/${appState.userId}/mark_sheets`, appState.currentExamId);
            const examsDocRef = doc(appState.db, `/artifacts/${appId}/users/${appState.userId}/mark_sheets`, 'exam_list');

            // Listen to data changes for the current exam
            onSnapshot(dataDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    const mergedData = { 
                        ...INITIAL_DATA, 
                        ...loadedData, 
                        institution: { ...INITIAL_DATA.institution, ...loadedData.institution } 
                    };
                    appState.data = mergedData;
                    appState.rankedStudents = rankAndCalculate(mergedData.students, mergedData.subjects);
                    render();
                    console.log(`Data loaded for exam: ${appState.currentExamId}`);
                } else {
                    appState.data = INITIAL_DATA;
                    appState.data.institution.examName = appState.examList.find(e => e.id === appState.currentExamId)?.name || 'New Examination';
                    appState.rankedStudents = [];
                    render();
                    console.log(`No data found for exam ID: ${appState.currentExamId}. Initializing.`);
                }
            }, (error) => console.error("Error listening to data:", error));


            // Listen to exam list changes
            onSnapshot(examsDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().exams) {
                    appState.examList = docSnap.data().exams;
                    renderSidebar();
                } else {
                    appState.examList = [];
                    // Ensure a default exam exists if list is empty
                    if (!appState.examList.some(e => e.id === 'default-exam')) {
                       appState.examList.push({ id: 'default-exam', name: 'Default Exam' });
                    }
                    renderSidebar();
                }
            }, (error) => console.error("Error listening to exam list:", error));
        };
        
        /** Database: Initialize Firebase */
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                console.error("Firebase config is missing or invalid. Data persistence disabled. Please update USER_PROVIDED_FIREBASE_CONFIG.");
                appState.isAuthReady = true;
                // Use a stable, fallback ID for non-persistent mode, so at least data stays for the current session without refresh.
                appState.userId = 'FALLBACK-NON-PERSISTENT-USER';
                render();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                appState.db = getFirestore(app);
                appState.auth = getAuth(app);

                onAuthStateChanged(appState.auth, async (user) => {
                    if (user) {
                        appState.userId = user.uid;
                    } else {
                        // Use custom token if available, otherwise sign in anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(appState.auth, initialAuthToken).catch(err => {
                                console.error("Custom token sign-in failed:", err);
                                signInAnonymously(appState.auth);
                            });
                        } else {
                            await signInAnonymously(appState.auth);
                        }
                    }
                    appState.isAuthReady = true;
                    attachDataListener();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                appState.isAuthReady = true;
                appState.userId = 'FALLBACK-NON-PERSISTENT-USER';
                render();
            }
        };


        // --- UI RENDER FUNCTIONS ---

        /** Global UI render function */
        const render = () => {
            if (!appState.isAuthReady) {
                document.getElementById('loading-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                return;
            }

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            renderSidebar();
            
            const mainContent = document.getElementById('main-content-area');
            mainContent.innerHTML = ''; // Clear previous content

            switch (appState.activeTab) {
                case 'marksheet':
                    mainContent.innerHTML = renderMarksheetTab();
                    break;
                case 'reports':
                    mainContent.innerHTML = renderReportsTab();
                    break;
                case 'settings':
                    mainContent.innerHTML = renderSettingsTab();
                    break;
            }
            // Reattach all specific event listeners after DOM update
            attachEventListeners();
        };

        const setActiveTab = (tab) => {
            appState.activeTab = tab;
            render();
        };

        const renderSidebar = () => {
            const sidebar = document.getElementById('sidebar-menu');
            if (!sidebar) return;

            // Navigation
            let navHtml = ['Marksheet', 'Reports', 'Settings'].map(name => {
                const tab = name.toLowerCase().replace(' ', '');
                const isActive = appState.activeTab === tab;
                return `
                    <button onclick="setActiveTab('${tab}')" class="w-full text-left p-3 rounded-lg font-medium transition-colors ${
                        isActive ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-700 hover:bg-gray-200'
                    }">
                        ${name}
                    </button>
                `;
            }).join('');
            
            // Exam Selector
            const examOptionsHtml = appState.examList.map(exam => `
                <button
                    onclick="switchExam('${exam.id}')"
                    class="w-full text-left text-sm p-2 rounded-md transition-colors mb-1 truncate ${
                        appState.currentExamId === exam.id ? 'bg-indigo-100 text-indigo-700 font-bold' : 'text-gray-600 hover:bg-gray-100'
                    }"
                    title="${exam.name}"
                >
                    ${exam.name}
                </button>
            `).join('');

            const sidebarHtml = `
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Navigation</h2>
                ${navHtml}
                
                <div class="border-t border-gray-200 pt-4 mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Exam Selector</h3>
                    ${examOptionsHtml}
                    <div class="mt-4 flex space-x-2" id="add-exam-form">
                        <input type="text" id="new-exam-name" placeholder="New Exam Name" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"/>
                        <button id="btn-add-exam" class="px-4 py-2 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600 transition-colors">Add</button>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4 mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">My User ID</h3>
                    <p class="text-xs break-all bg-gray-100 p-2 rounded-lg text-gray-600">
                        ${appState.userId || 'Loading...'}
                    </p>
                    <p class="text-xs text-gray-500 mt-1">This ID keeps your data secure and separate.</p>
                </div>
            `;
            sidebar.innerHTML = sidebarHtml;
            document.getElementById('btn-add-exam').addEventListener('click', handleAddExam);
        };
        
        // --- Tab Renderers ---

        const renderMarksheetTable = (students, subjects) => {
            
            const headerCells = subjects.map(s => `
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">
                    ${s.name} (/${s.maxMark}${s.streamFilter ? ' - ' + s.streamFilter.split(' ')[0] : ''})
                </th>
            `).join('');

            const studentRows = students.map(student => {
                const markCells = subjects.map(subject => {
                    const markEntry = student.marks[subject.id] || {};
                    const isRelevant = !subject.streamFilter || subject.streamFilter === student.stream;
                    
                    let cellContent = '';
                    if (isRelevant) {
                        cellContent = `
                            <div class="p-1 rounded-md ${markEntry.bgColor || 'bg-gray-100'}">
                                <span class="font-mono font-medium text-gray-800">${markEntry.score || 0}</span>
                                <span class="block text-xs font-bold ${markEntry.color || 'text-gray-500'}">${markEntry.grade || 'N/A'}</span>
                            </div>
                        `;
                    } else {
                        cellContent = `<span class="text-xs text-gray-400 font-mono">N/A</span>`;
                    }

                    return `<td class="px-3 py-2 text-sm text-center">${cellContent}</td>`;
                }).join('');

                return `
                    <tr class="hover:bg-indigo-50/50 transition-colors">
                        <td class="px-3 py-2 text-sm text-gray-900 font-semibold text-center">${student.rank}</td>
                        <td class="px-3 py-2 text-sm text-gray-900">${student.name}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${student.stream}</td>
                        ${markCells}
                        <td class="px-3 py-2 text-sm font-bold text-center text-indigo-700">
                            ${student.total}
                            <span class="block text-xs font-normal text-gray-500">/${student.totalMaxMark}</span>
                        </td>
                        <td class="px-3 py-2 text-sm font-semibold text-center">${student.percentage}%</td>
                        <td class="px-3 py-2 text-center">
                            <button data-student-id="${student.id}" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium transition-colors view-report-btn">
                                View Report
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const emptyRow = students.length === 0 ? `
                <tr><td colspan="${subjects.length + 5}" class="py-4 text-center text-gray-500">No student data available. Please add students or upload marks.</td></tr>
            ` : '';

            return `
                <div class="overflow-x-auto shadow-xl rounded-lg bg-white p-4">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">Whole Mark Sheet - Ranked</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Stream</th>
                                ${headerCells}
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Total Score / Max</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Percentage</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${studentRows}
                            ${emptyRow}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        const renderMarksheetTab = () => {
            const streamOptionsHtml = STREAMS.map(stream => `<option value="${stream}">${stream}</option>`).join('');
            
            const studentEntryRows = appState.data.students.map(student => {
                const subjectInputs = appState.data.subjects.map(subject => {
                    const isRelevant = !subject.streamFilter || subject.streamFilter === student.stream;

                    if (!isRelevant) {
                        return `<td class="px-3 py-2 text-center text-gray-400 text-sm italic">N/A</td>`;
                    }

                    if (subject.isComposite && subject.subSubjects.length > 0) {
                        const subInputs = subject.subSubjects.map(ss => `
                            <div class="flex items-center justify-center space-x-1 text-xs">
                                <label class="text-gray-600 font-medium">${ss.name} (/${ss.maxMark}):</label>
                                <input
                                    type="number" min="0" max="${ss.maxMark}"
                                    data-student-id="${student.id}" data-subject-id="${subject.id}" data-subsubject-name="${ss.name}"
                                    value="${student.marks[subject.id]?.subMarks?.[ss.name] || ''}"
                                    class="w-16 p-1 border border-gray-300 rounded-md text-center text-sm sub-mark-input"
                                />
                            </div>
                        `).join('');
                        return `<td class="px-3 py-2 text-center"><div class="space-y-1">${subInputs}</div></td>`;
                    } else {
                        return `
                            <td class="px-3 py-2 text-center">
                                <input
                                    type="number" min="0" max="${subject.maxMark}"
                                    data-student-id="${student.id}" data-subject-id="${subject.id}"
                                    value="${student.marks[subject.id]?.score || ''}"
                                    class="w-20 p-2 border border-gray-300 rounded-lg text-center font-mono mark-input"
                                />
                            </td>
                        `;
                    }
                }).join('');

                return `
                    <tr class="hover:bg-gray-50/50 transition-colors">
                        <td class="px-3 py-2 text-sm font-semibold text-gray-900 flex justify-between items-center">
                            <span>${student.name} <span class="block text-xs font-normal text-gray-500">(${student.stream})</span></span>
                            <button data-student-id="${student.id}" class="text-xs px-2 py-1 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors delete-student-btn">
                                Delete
                            </button>
                        </td>
                        ${subjectInputs}
                    </tr>
                `;
            }).join('');

            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-800">${appState.data.institution.examName} - Mark Sheet Entry</h2>
                    
                    <!-- NEW: Data Persistence & Google Sheets Guide -->
                    <div class="p-4 bg-indigo-50 border-l-4 border-indigo-600 text-indigo-800 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-1 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg>
                            Data Persistence & Google Sheets Guide
                        </h3>
                        <p class="text-sm">
                            Your data is **automatically saved** and secured in a cloud database (**Firebase Firestore**) linked to your User ID. It will not be deleted unless you manually delete records.
                        </p>
                        <p class="text-sm mt-2 font-semibold">
                            To use Google Sheets:
                            <ol class="list-decimal list-inside ml-2 mt-1 space-y-0.5 text-gray-700">
                                <li>**Export to Sheet:** Use the "Download CSV" button below.</li>
                                <li>**Import to Google Sheets:** Open your Google Sheet, go to File > Import > Upload (your CSV file).</li>
                                <li>**Import to App:** Edit your Sheet, then use File > Download > **Comma Separated Values (.csv)**. Upload that file using the Uploader below to update the app.</li>
                            </ol>
                        </p>
                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Add New Student -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <h3 class="text-xl font-bold text-indigo-700 mb-4">Add New Student</h3>
                            <div class="space-y-3" id="add-student-form">
                                <input type="text" id="student-name-input" placeholder="Student Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                                <select id="student-stream-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                    ${streamOptionsHtml}
                                </select>
                                
                                <!-- NEW: File Upload Input -->
                                <label class="block text-sm font-medium text-gray-700 pt-2">Upload Photo (Optional, PNG/JPG)</label>
                                <input type="file" id="student-photo-upload" accept="image/png, image/jpeg" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/>
                                
                                <input type="url" id="student-photo-url" placeholder="or paste Photo URL" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                                
                                <button id="btn-add-student" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-shadow shadow-md hover:shadow-lg">
                                    Add Student
                                </button>
                            </div>
                        </div>

                        <!-- Upload Excel/CSV -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <h3 class="text-xl font-bold text-indigo-700 mb-4">Upload Marks (CSV/Excel)</h3>
                            <p class="text-sm text-gray-600 mb-3">Upload a CSV file. Format: <code>Name, Stream, PhotoURL, Subject1 Mark, Subject2 Mark, ...</code></p>
                            <input type="file" accept=".csv" id="csv-upload-input" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            <p id="upload-message" class="mt-3 text-sm italic text-indigo-500">${appState.uploadMessage}</p>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 border-b pb-2">Student Mark Entry</h3>
                    <div class="overflow-x-auto shadow-xl rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase">Name (Stream)</th>
                                    ${appState.data.subjects.map(s => `
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase whitespace-nowrap">
                                            ${s.name} (Max: ${s.maxMark}${s.streamFilter ? ' - ' + s.streamFilter.split(' ')[0] : ''})
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="mark-entry-table-body">
                                ${studentEntryRows}
                                ${appState.data.students.length === 0 ? `<tr><td colspan="${appState.data.subjects.length + 1}" class="py-4 text-center text-gray-500">No students added yet.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Whole Mark Sheet (Ranked)</h3>
                        ${renderMarksheetTable(appState.rankedStudents, appState.data.subjects)}
                        
                        <div class="mt-6 flex space-x-4 justify-center">
                            <button id="download-marksheet-csv" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-shadow">
                                Download Mark Sheet (Excel/CSV)
                            </button>
                            <button id="download-marksheet-pdf" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-shadow">
                                Download Mark Sheet (PDF/Print)
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderProgressReportViewer = (student) => {
            if (!student) return `
                <div class="text-center p-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                    <p class="text-lg text-gray-500">Select a student above to view their detailed progress report.</p>
                </div>
            `;
            
            const subjectRows = appState.data.subjects
                .filter(s => !s.streamFilter || s.streamFilter === student.stream) // Filter subjects for report
                .map(s => {
                    const markEntry = student.marks[s.id] || {};
                    
                    const subSubjectRows = s.isComposite && s.subSubjects.length > 0 ? 
                        s.subSubjects.map(ss => `
                            <tr class="bg-white text-gray-600 hover:bg-gray-50">
                                <td class="px-6 py-2 text-xs italic">-- ${ss.name}</td>
                                <td class="px-4 py-2 text-xs text-center">${ss.maxMark}</td>
                                <td class="px-4 py-2 text-xs text-center">${student.marks[s.id]?.subMarks?.[ss.name] || 0}</td>
                                <td colspan="2" class="px-4 py-2 text-xs text-center"></td>
                            </tr>
                        `).join('') : '';

                    return `
                        <tr class="bg-indigo-50/50">
                            <td class="px-4 py-3 text-sm font-semibold text-gray-800">${s.name}</td>
                            <td class="px-4 py-3 text-sm text-center">${markEntry.maxMark || s.maxMark}</td>
                            <td class="px-4 py-3 text-sm font-bold text-center text-gray-800">${markEntry.score || 0}</td>
                            <td class="px-4 py-3 text-sm text-center font-medium">${markEntry.percentage || '0.00'}%</td>
                            <td class="px-4 py-3 text-sm font-extrabold text-center ${markEntry.color || 'text-gray-500'}">${markEntry.grade || 'N/A'}</td>
                        </tr>
                        ${subSubjectRows}
                    `;
            }).join('');

            return `
                <div class="p-8 bg-white border border-gray-200 rounded-xl shadow-xl space-y-6" id="progress-report-print">
                    <!-- Institution Header -->
                    <div class="flex justify-between items-start border-b-4 border-indigo-600 pb-4 mb-8">
                        <div>
                            <h1 class="text-3xl font-extrabold text-gray-800">${appState.data.institution.name}</h1>
                            <p class="text-sm text-gray-600 mt-1">${appState.data.institution.address}</p>
                            <p class="text-lg font-semibold text-indigo-600 mt-2">${appState.data.institution.examName} - Progress Report</p>
                        </div>
                        <!-- Logo Area -->
                        <img src="${appState.data.institution.logoUrl || 'https://placehold.co/100x40/4F46E5/ffffff?text=LOGO'}" alt="Logo" class="h-10 w-auto rounded-lg shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/100x40/4F46E5/ffffff?text=LOGO'"/>
                    </div>

                    <!-- Student Details -->
                    <div class="flex items-center justify-between bg-indigo-50 p-4 rounded-lg">
                        <div class="space-y-1">
                            <p class="text-lg font-bold text-gray-800">Student Name: <span class="text-indigo-700">${student.name}</span></p>
                            <p class="text-md text-gray-700">Stream: <span class="font-medium">${student.stream}</span></p>
                            <p class="text-md text-gray-700">Overall Rank: <span class="font-bold bg-indigo-200 px-2 py-0.5 rounded text-indigo-800">${student.rank}</span></p>
                        </div>
                        ${student.photoUrl ? `<img src="${student.photoUrl}" alt="${student.name}'s Photo" class="w-20 h-20 object-cover rounded-full border-4 border-indigo-300 shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/80x80/cccccc/333333?text=No+Photo'"/>` : ''}
                    </div>

                    <!-- Mark Breakdown Table -->
                    <h3 class="text-2xl font-semibold text-gray-700 mt-6 border-b pb-2">Subject Performance</h3>
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Max Mark</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Score</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Percentage</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Grade</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${subjectRows}
                        </tbody>
                    </table>

                    <!-- Summary -->
                    <div class="pt-4 mt-6 border-t border-dashed border-gray-300">
                        <h3 class="text-2xl font-semibold text-gray-700">Overall Summary</h3>
                        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                            <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                                <p class="text-sm text-gray-600">Total Marks Obtained</p>
                                <p class="text-3xl font-bold text-green-700 mt-1">${student.total}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                                <p class="text-sm text-gray-600">Total Max Mark</p>
                                <p class="text-3xl font-bold text-blue-700 mt-1">${student.totalMaxMark}</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200">
                                <p class="text-sm text-gray-600">Overall Percentage</p>
                                <p class="text-3xl font-bold text-indigo-700 mt-1">${student.percentage}%</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-center text-gray-400 pt-4">Generated by The Mark Upload System (User ID: ${appState.userId})</p>
                </div>
            `;
        };

        const renderReportsTab = () => {
            const selectedStudent = appState.rankedStudents.find(s => s.id === appState.selectedStudentId);
            
            const studentOptions = appState.rankedStudents.map(s => `
                <option value="${s.id}" ${s.id === appState.selectedStudentId ? 'selected' : ''}>
                    ${s.name} (Rank: ${s.rank})
                </option>
            `).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-gray-800">Student Progress Reports</h2>

                    <!-- Student Selector -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100 flex items-center space-x-4 no-print">
                        <select id="student-selector" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-800">
                            <option value="">-- Select a Student for Report --</option>
                            ${studentOptions}
                        </select>

                        ${selectedStudent ? `
                            <div class="flex space-x-3">
                                <button id="download-report-csv" class="px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-shadow text-sm whitespace-nowrap">
                                    Download CSV
                                </button>
                                <button id="download-report-pdf" class="px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-shadow text-sm whitespace-nowrap">
                                    Download PDF
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Individual Report View -->
                    ${renderProgressReportViewer(selectedStudent)}
                </div>
            `;
        };

        const renderSettingsTab = () => {
            const streamOptionsForSubject = [''].concat(STREAMS).map(stream => 
                `<option value="${stream}" ${stream === '' ? 'selected' : ''}>${stream || 'Common (All Streams)'}</option>`
            ).join('');

            const subjectListHtml = appState.data.subjects.map(s => {
                const subSubjectList = s.subSubjects.map(ss => `
                    <div class="flex justify-between items-center text-sm ml-4 bg-gray-50 p-2 rounded-md shadow-inner">
                        <div class="flex items-center space-x-2 flex-grow">
                            <input type="text" 
                                data-parent-id="${s.id}" data-original-name="${ss.name}" data-field="name"
                                value="${ss.name}" placeholder="Sub-subject Name"
                                class="w-1/2 p-1 border border-gray-300 rounded-md text-sm subsubject-detail-input font-medium"/>
                            <span class="text-gray-500">Max:</span>
                            <input type="number" min="1" 
                                data-parent-id="${s.id}" data-original-name="${ss.name}" data-field="maxMark"
                                value="${ss.maxMark}"
                                class="w-20 p-1 border border-gray-300 rounded-md text-center text-sm subsubject-detail-input"/>
                        </div>
                        <button data-subject-id="${s.id}" data-subsubject-name="${ss.name}" class="text-xs px-3 py-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors remove-subsubject-btn">Remove</button>
                    </div>
                `).join('');
                
                // Max Mark Control
                const maxMarkControl = s.isComposite ? 
                    `<span class="text-sm font-semibold text-indigo-500">Total: ${s.maxMark}</span>` : 
                    `<div class="flex items-center space-x-1">
                        <label class="text-sm text-gray-500 whitespace-nowrap">Max Mark:</label>
                        <input type="number" min="1" value="${s.maxMark}" data-subject-id="${s.id}" class="w-20 p-1 border border-gray-300 rounded-md text-center text-sm subject-max-mark-input"/>
                    </div>`;

                // Stream Tag Display
                const streamTag = s.streamFilter ? 
                    `<span class="text-xs font-medium text-white px-2 py-0.5 rounded-full bg-blue-500 ml-2">${s.streamFilter.split(' ')[0]} Stream</span>` : 
                    `<span class="text-xs font-medium text-gray-700 px-2 py-0.5 rounded-full bg-gray-200 ml-2">Common</span>`;


                return `
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-gray-800">${s.name} ${streamTag}</span>
                            <div class="flex items-center space-x-4">
                                ${maxMarkControl}
                                <div class="space-x-2">
                                    <button data-subject-id="${s.id}" class="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors add-subsubject-btn">+ Sub-subject</button>
                                    <button data-subject-id="${s.id}" class="text-xs px-3 py-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors remove-subject-btn">Remove</button>
                                </div>
                            </div>
                        </div>
                        ${s.subSubjects.length > 0 ? `<div class="mt-3 border-t pt-3 space-y-2"><p class="text-sm font-medium text-gray-600">Sub-subjects (Total Max: ${s.maxMark})</p>${subSubjectList}</div>` : ''}
                    </div>
                `;
            }).join('');

            const gradeScaleHtml = GRADE_SCALE.map(g => `
                <div class="text-center">
                    <p class="text-xs text-gray-600">Min %</p>
                    <p class="text-lg font-bold">${g.threshold}%</p>
                    <p class="text-2xl font-extrabold ${g.color} ${g.grade === 'F' || g.grade === 'A+' ? 'bg-' + g.color.replace('text-', '').replace('-600', '-100') + ' p-1 rounded' : ''}">${g.grade}</p>
                </div>
            `).join('');

            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-800">Application Settings</h2>

                    <!-- Institution Details -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Institution Details</h3>
                        <div class="space-y-3">
                            <input type="text" id="inst-name" placeholder="Institution Name" value="${appState.data.institution.name}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                            <input type="text" id="inst-address" placeholder="Institution Address" value="${appState.data.institution.address}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                            <input type="url" id="inst-logo-url" placeholder="Logo URL (Appears on reports)" value="${appState.data.institution.logoUrl}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                            <!-- FIX: Added input for current Examination Name -->
                            <input type="text" id="inst-examName" placeholder="Examination Name (e.g., Mid-Term 2025)" value="${appState.data.institution.examName}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                        </div>
                    </div>

                    <!-- Subject Management -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Subject Management</h3>
                        
                        <!-- Add Subject Form -->
                        <div class="p-4 bg-indigo-50 rounded-lg mb-6">
                            <h4 class="font-semibold text-indigo-700 mb-2">Add New Subject</h4>
                            <div class="flex flex-wrap items-end gap-3">
                                <div class="flex-grow">
                                    <label class="block text-sm font-medium text-indigo-700 mb-1">Name</label>
                                    <input type="text" id="new-subject-name" placeholder="Subject Name" class="w-full p-2 border border-gray-300 rounded-lg"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-indigo-700 mb-1">Max Mark</label>
                                    <input type="number" id="new-subject-max-mark" placeholder="Max Mark" min="1" value="100" class="w-24 p-2 border border-gray-300 rounded-lg text-center"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-indigo-700 mb-1">Stream Filter</label>
                                    <select id="new-subject-stream" class="p-2 border border-gray-300 rounded-lg bg-white w-40 text-sm text-gray-700">
                                        ${streamOptionsForSubject}
                                    </select>
                                </div>
                                <button id="btn-add-subject" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Add Subject</button>
                            </div>
                        </div>

                        <!-- Existing Subjects List -->
                        <div class="space-y-4">
                            ${subjectListHtml}
                            ${appState.data.subjects.length === 0 ? '<p class="text-center text-gray-500 italic">No subjects added yet. Add a subject to start!</p>' : ''}
                        </div>
                    </div>

                     <!-- Grading Scale Info -->
                    <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Grading Scale Reference</h3>
                        <div class="flex space-x-4 justify-between overflow-x-auto">
                            ${gradeScaleHtml}
                        </div>
                    </div>
                </div>
            `;
        };
        

        // --- HANDLERS AND EVENT ATTACHMENTS ---

        const handleAddExam = async () => {
            const newExamNameInput = document.getElementById('new-exam-name');
            const newExamName = newExamNameInput?.value.trim();

            if (!newExamName || !appState.db || !appState.userId) return;

            const newExamId = `exam-${Date.now()}`;
            const newExamEntry = { id: newExamId, name: newExamName };
            const updatedExamList = [...appState.examList, newExamEntry];
            
            // 1. Save the updated list of exams
            const examsDocRef = doc(appState.db, `/artifacts/${appId}/users/${appState.userId}/mark_sheets`, 'exam_list');
            await setDoc(examsDocRef, { exams: updatedExamList }, { merge: true });

            // 2. Create the new exam's data document with initial structure
            const dataDocRef = doc(appState.db, `/artifacts/${appId}/users/${appState.userId}/mark_sheets`, newExamId);
            await setDoc(dataDocRef, { ...INITIAL_DATA, institution: { ...INITIAL_DATA.institution, examName: newExamName } });

            appState.currentExamId = newExamId;
            newExamNameInput.value = '';
            // The onSnapshot listener will handle the rendering automatically
        };

        const handleAddStudent = async () => { // Function is now ASYNC
            const nameInput = document.getElementById('student-name-input');
            const streamSelect = document.getElementById('student-stream-input');
            const photoUrlInput = document.getElementById('student-photo-url'); // Input for URL
            const photoFileInput = document.getElementById('student-photo-upload'); // Input for File
            
            const name = nameInput.value.trim();
            if (!name) return;

            let photoData = photoUrlInput.value.trim();
            const file = photoFileInput.files[0];

            if (file) {
                // If a file is selected, convert it to Base64 and use that data
                try {
                    photoData = await fileToBase64(file);
                } catch (e) {
                    console.error("Error converting file to Base64:", e);
                    photoData = ''; // Fallback
                }
            }


            const newStudent = {
                id: `s-${appState.data.nextStudentId}`,
                name: name,
                stream: streamSelect.value,
                photoUrl: photoData, // Use converted Base64 data or provided URL
                marks: {},
                total: 0,
                percentage: '0.00',
                rank: appState.data.students.length + 1,
            };

            const newStudents = [...appState.data.students, newStudent];
            saveData({ students: newStudents, nextStudentId: appState.data.nextStudentId + 1 });
            
            nameInput.value = '';
            photoUrlInput.value = '';
            photoFileInput.value = ''; // Clear file input after use
            // Re-render handled by saveData
        };

        const handleMarkChange = (e) => {
            const studentId = e.target.dataset.studentId;
            const subjectId = e.target.dataset.subjectId;
            const score = Math.max(0, parseInt(e.target.value) || 0);

            const newStudents = appState.data.students.map(s => {
                if (s.id === studentId) {
                    return {
                        ...s,
                        marks: {
                            ...s.marks,
                            [subjectId]: {
                                ...s.marks[subjectId],
                                score: score
                            }
                        }
                    };
                }
                return s;
            });

            saveData({ students: newStudents }, false); // Do not force render, rely on Firestore
        };

        const handleSubMarkChange = (e) => {
            const studentId = e.target.dataset.studentId;
            const subjectId = e.target.dataset.subjectId;
            const subSubjectName = e.target.dataset.subsubjectName;
            const score = Math.max(0, parseInt(e.target.value) || 0);

            const newStudents = appState.data.students.map(s => {
                if (s.id === studentId) {
                    const existingMarks = s.marks[subjectId] || {};
                    const existingSubMarks = existingMarks.subMarks || {};
                    
                    return {
                        ...s,
                        marks: {
                            ...s.marks,
                            [subjectId]: {
                                ...existingMarks,
                                subMarks: {
                                    ...existingSubMarks,
                                    [subSubjectName]: score
                                }
                            }
                        }
                    };
                }
                return s;
            });
            saveData({ students: newStudents }, false); // Do not force render
        };

        const handleAddSubject = () => {
            const nameInput = document.getElementById('new-subject-name');
            const maxMarkInput = document.getElementById('new-subject-max-mark');
            const streamInput = document.getElementById('new-subject-stream');
            
            const name = nameInput.value.trim();
            const maxMark = parseInt(maxMarkInput.value) || 0;
            const streamFilter = streamInput.value || null;

            if (!name || maxMark <= 0) return;

            const newId = `sub-${Math.random().toString(36).substr(2, 9)}`;
            const subjectToAdd = {
                id: newId,
                name: name,
                maxMark: maxMark,
                streamFilter: streamFilter,
                isComposite: false,
                subSubjects: []
            };

            const updatedSubjects = [...appState.data.subjects, subjectToAdd];

            saveData({ subjects: updatedSubjects });
            nameInput.value = '';
            maxMarkInput.value = 100;
            streamInput.value = '';
        };
        
        const handleSubjectMaxMarkChange = (e) => {
            const subjectId = e.target.dataset.subjectId;
            // Ensure max mark is at least 1
            const newMaxMark = Math.max(1, parseInt(e.target.value) || 1); 

            const updatedSubjects = appState.data.subjects.map(s => {
                if (s.id === subjectId) {
                    return { ...s, maxMark: newMaxMark };
                }
                return s;
            });
            saveData({ subjects: updatedSubjects });
        };


        const handleRemoveSubject = (e) => {
            const idToRemove = e.target.dataset.subjectId;
             // Check against the instruction rule of no alerts/confirms
            console.log(`Confirmation: Are you sure you want to remove subject ${idToRemove}?`);
            
            // In a real app, a custom modal would confirm this. Simulating approval:
            if (true) {
                const updatedSubjects = appState.data.subjects.filter(s => s.id !== idToRemove);
                
                // Also remove the subject's marks from all students
                const updatedStudents = appState.data.students.map(s => {
                    const { [idToRemove]: removedMark, ...restMarks } = s.marks;
                    return { ...s, marks: restMarks };
                });

                saveData({ subjects: updatedSubjects, students: updatedStudents });
            }
        };

        const handleAddSubSubject = (e) => {
            const subjectId = e.target.dataset.subjectId;
            const newSubjects = appState.data.subjects.map(s => {
                if (s.id === subjectId) {
                    const newSub = { name: `Sub-Part ${s.subSubjects.length + 1}`, maxMark: 50 };
                    const newSubs = [...s.subSubjects, newSub];
                    const newMaxMark = newSubs.reduce((sum, ss) => sum + ss.maxMark, 0);
                    return { ...s, subSubjects: newSubs, maxMark: newMaxMark, isComposite: true };
                }
                return s;
            });
            saveData({ subjects: newSubjects });
        };
        
        const handleRemoveSubSubject = (e) => {
            const subjectId = e.target.dataset.subjectId;
            const subSubjectName = e.target.dataset.subsubjectName;

            const newSubjects = appState.data.subjects.map(s => {
                if (s.id === subjectId) {
                    const newSubs = s.subSubjects.filter(ss => ss.name !== subSubjectName);
                    const newMaxMark = newSubs.reduce((sum, ss) => sum + ss.maxMark, 0);
                    return { ...s, subSubjects: newSubs, maxMark: newMaxMark, isComposite: newSubs.length > 0 };
                }
                return s;
            });
            saveData({ subjects: newSubjects });
        };
        
        /** NEW: Handles changes to sub-subject name or max mark */
        const handleSubSubjectDetailChange = (e) => {
            const parentId = e.target.dataset.parentId;
            const originalName = e.target.dataset.originalName;
            const field = e.target.dataset.field;
            let value = e.target.value;
            
            if (field === 'maxMark') {
                value = Math.max(1, parseInt(value) || 1);
                e.target.value = value; 
            } else if (field === 'name') {
                value = value.trim();
            }

            const updatedSubjects = appState.data.subjects.map(s => {
                if (s.id === parentId) {
                    const newSubSubjects = s.subSubjects.map(ss => {
                        if (ss.name === originalName) {
                            // Update the specific field
                            return { 
                                ...ss, 
                                [field]: field === 'maxMark' ? value : value
                            };
                        }
                        return ss;
                    });
                    
                    // Recalculate parent max mark based on the updated sub-subjects
                    const newMaxMark = newSubSubjects.reduce((sum, ss) => sum + ss.maxMark, 0);
                    
                    return { ...s, subSubjects: newSubSubjects, maxMark: newMaxMark, isComposite: true };
                }
                return s;
            });
            
            // saveData triggers a full re-render, updating data-original-name attribute if the name was changed.
            saveData({ subjects: updatedSubjects });
        };

        /** NEW: Handles student deletion */
        const handleDeleteStudent = (e) => {
            const studentId = e.target.dataset.studentId;
            
            // In a real application, this would be a custom modal confirmation.
            // Simulating approval for demonstration:
            console.log(`Confirmation: Deleting student ID: ${studentId}.`);

            const updatedStudents = appState.data.students.filter(s => s.id !== studentId);
            
            // Recalculate ranks and save the new list
            saveData({ students: updatedStudents });
        };


        const handleInstDetailChange = (e) => {
            const key = e.target.id.replace('inst-', '');
            const value = e.target.value;
            saveData({ institution: { ...appState.data.institution, [key]: value } }, false); // No force render
        };

        const handleStudentSelectorChange = (e) => {
            appState.selectedStudentId = e.target.value;
            render();
        };
        
        // --- DOWNLOAD/FILE HANDLERS ---
        
        /** Utility: Downloads a string content as a file */
        const downloadFile = (content, filename, mimeType) => {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        /** Utility: Converts data to a CSV string */
        const convertToCsv = (data, headers) => {
            const csvRows = [];
            csvRows.push(headers.join(','));
            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    const formattedValue = ('' + value).replace(/"/g, '""');
                    return formattedValue.includes(',') || formattedValue.includes('"') ? `"${formattedValue}"` : formattedValue;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        };

        const handleDownloadWholeMarksheet = (format) => {
            if (appState.rankedStudents.length === 0) {
                 console.log('Notification: No data to download.');
                 return;
            }

            if (format === 'csv') {
                const baseHeaders = ['Rank', 'Name', 'Stream', 'Total Score', 'Total Max Mark', 'Percentage'];
                const subjectHeaders = appState.data.subjects.flatMap(s => [`${s.name} Score`, `${s.name} Grade`, `${s.name} %`]);
                const allHeaders = [...baseHeaders, ...subjectHeaders];

                const csvData = appState.rankedStudents.map(student => {
                    const row = {
                        'Rank': student.rank,
                        'Name': student.name,
                        'Stream': student.stream,
                        'Total Score': student.total,
                        'Total Max Mark': student.totalMaxMark,
                        'Percentage': student.percentage + '%',
                    };
                    
                    appState.data.subjects.forEach(s => {
                        const markEntry = student.marks[s.id] || {};
                        row[`${s.name} Score`] = markEntry.score || 0;
                        row[`${s.name} Grade`] = markEntry.grade || 'N/A';
                        row[`${s.name} %`] = markEntry.percentage || '0.00';
                    });
                    return row;
                });

                const csvContent = convertToCsv(csvData, allHeaders);
                downloadFile(csvContent, `${appState.data.institution.examName}_Marksheet.csv`, 'text/csv;charset=utf-8;');
            } else if (format === 'pdf') {
                // To get a PDF, user must print the rendered table view.
                console.log('Notification: To save as PDF, please use your browser\'s Print function (Ctrl+P or Cmd+P) and select "Save as PDF".');
            }
        };

        const handleDownloadIndividualReport = (student, format) => {
            if (format === 'csv') {
                const reportData = [
                    { Key: 'Student Name', Value: student.name },
                    { Key: 'Stream', Value: student.stream },
                    { Key: 'Overall Rank', Value: student.rank },
                    { Key: 'Total Score', Value: student.total },
                    { Key: 'Total Max Mark', Value: student.totalMaxMark },
                    { Key: 'Overall Percentage', Value: `${student.percentage}%` },
                ];
                
                // Only include relevant subjects in the report CSV
                const relevantSubjects = appState.data.subjects.filter(s => !s.streamFilter || s.streamFilter === student.stream);

                relevantSubjects.forEach(s => {
                    const markEntry = student.marks[s.id] || {};
                    reportData.push({ Key: `${s.name} Score`, Value: markEntry.score || 0 });
                    reportData.push({ Key: `${s.name} Grade`, Value: markEntry.grade || 'N/A' });
                    reportData.push({ Key: `${s.name} Percentage`, Value: `${markEntry.percentage || '0.00'}%` });
                });

                const csvContent = convertToCsv(reportData, ['Key', 'Value']);
                downloadFile(csvContent, `${student.name}_Progress_Report.csv`, 'text/csv;charset=utf-8;');
            } else if (format === 'pdf') {
                // Set the student and trigger print on the report view
                appState.selectedStudentId = student.id;
                appState.activeTab = 'reports';
                render();
                setTimeout(() => {
                    window.print();
                }, 100);
            }
        };

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            const uploadMessageEl = document.getElementById('upload-message');
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    const rows = content.trim().split('\n').filter(row => row.trim() !== '');
                    if (rows.length < 1) {
                        uploadMessageEl.textContent = 'File is empty.';
                        return;
                    }
                    
                    const headers = rows[0].split(',').map(h => h.trim());
                    const subjectNamesFromCsv = headers.slice(3).filter(h => h.trim());

                    if (subjectNamesFromCsv.length === 0) {
                        uploadMessageEl.textContent = 'CSV must contain "Name", "Stream", "PhotoURL" and at least one subject mark column.';
                        return;
                    }

                    // 1. Add/Update Subjects - Assume subjects added from CSV are 'Common' by default
                    const existingSubjectNames = new Set(appState.data.subjects.map(s => s.name));
                    let updatedSubjects = [...appState.data.subjects];

                    subjectNamesFromCsv.forEach(subjectName => {
                        if (!existingSubjectNames.has(subjectName)) {
                            updatedSubjects.push({
                                id: `sub-${Math.random().toString(36).substr(2, 9)}`,
                                name: subjectName,
                                maxMark: 100, // Default max mark for new subjects from CSV
                                streamFilter: null, // Default to Common
                                isComposite: false,
                                subSubjects: []
                            });
                        }
                    });

                    const subjectNameToId = updatedSubjects.reduce((acc, sub) => {
                        acc[sub.name] = sub.id;
                        return acc;
                    }, {});

                    // 2. Process Student Rows
                    let currentId = appState.data.nextStudentId;
                    const newStudents = rows.slice(1).map(row => {
                        const values = row.split(',').map(v => v.trim());
                        if (values.length < 3) return null;

                        const studentData = {
                            id: `s-${currentId++}`,
                            name: values[0],
                            stream: values[1],
                            photoUrl: values[2] || '',
                            marks: {},
                        };
                        
                        values.slice(3).forEach((scoreStr, index) => {
                            const subjectName = subjectNamesFromCsv[index];
                            const subjectId = subjectNameToId[subjectName];
                            if (subjectId) {
                                studentData.marks[subjectId] = { score: parseInt(scoreStr) || 0 };
                            }
                        });

                        return studentData;
                    }).filter(s => s !== null);

                    saveData({
                        subjects: updatedSubjects,
                        students: newStudents, 
                        nextStudentId: currentId
                    });

                    uploadMessageEl.textContent = `Successfully processed ${newStudents.length} students. New subjects added/updated.`;

                } catch (error) {
                    uploadMessageEl.textContent = `Error processing file: ${error.message}`;
                    console.error("File processing error:", error);
                }
            };
            reader.readAsText(file);
        };


        /** Attaches all event listeners after a full DOM render */
        const attachEventListeners = () => {
            // --- Marksheet Tab ---
            document.getElementById('btn-add-student')?.addEventListener('click', handleAddStudent);
            document.getElementById('csv-upload-input')?.addEventListener('change', handleFileUpload);
            document.getElementById('download-marksheet-csv')?.addEventListener('click', () => handleDownloadWholeMarksheet('csv'));
            document.getElementById('download-marksheet-pdf')?.addEventListener('click', () => handleDownloadWholeMarksheet('pdf'));
            
            // Dynamic Mark Inputs
            document.querySelectorAll('.mark-input').forEach(input => {
                input.addEventListener('input', handleMarkChange);
            });
            document.querySelectorAll('.sub-mark-input').forEach(input => {
                input.addEventListener('input', handleSubMarkChange);
            });
            document.querySelectorAll('.view-report-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    appState.selectedStudentId = e.target.dataset.studentId;
                    setActiveTab('reports');
                });
            });
            
            // NEW: Student Delete Button
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', handleDeleteStudent);
            });


            // --- Reports Tab ---
            document.getElementById('student-selector')?.addEventListener('change', handleStudentSelectorChange);
            const selectedStudent = appState.rankedStudents.find(s => s.id === appState.selectedStudentId);
            if (selectedStudent) {
                document.getElementById('download-report-csv')?.addEventListener('click', () => handleDownloadIndividualReport(selectedStudent, 'csv'));
                document.getElementById('download-report-pdf')?.addEventListener('click', () => handleDownloadIndividualReport(selectedStudent, 'pdf'));
            }

            // --- Settings Tab ---
            document.getElementById('inst-name')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('inst-address')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('inst-logo-url')?.addEventListener('input', handleInstDetailChange);
            document.getElementById('inst-examName')?.addEventListener('input', handleInstDetailChange); // Listener for new exam name input
            document.getElementById('btn-add-subject')?.addEventListener('click', handleAddSubject);
            
            document.querySelectorAll('.remove-subject-btn').forEach(btn => btn.addEventListener('click', handleRemoveSubject));
            document.querySelectorAll('.add-subsubject-btn').forEach(btn => btn.addEventListener('click', handleAddSubSubject));
            document.querySelectorAll('.remove-subsubject-btn').forEach(btn => btn.addEventListener('click', handleRemoveSubSubject));
            
            // Max Mark Change Handler for simple subjects
            document.querySelectorAll('.subject-max-mark-input').forEach(input => {
                input.addEventListener('input', handleSubjectMaxMarkChange);
            });
            
            // NEW: Sub-subject detail change handler (name or mark)
            document.querySelectorAll('.subsubject-detail-input').forEach(input => {
                input.addEventListener('input', handleSubSubjectDetailChange);
            });
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            window.setActiveTab = setActiveTab; // Expose to global scope for buttons
            window.switchExam = window.switchExam; // Expose switch exam handler
            initializeFirebase();
        };

    </script>
</head>
<body class="bg-gray-100">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="text-2xl text-indigo-600 font-semibold flex items-center space-x-3">
            <svg class="animate-spin h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>Loading Application and Data...</span>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen flex hidden">
        
        <!-- Sidebar Menu -->
        <div id="sidebar-menu" class="no-print w-full md:w-1/4 bg-gray-50 border-r border-gray-200 p-6 space-y-6">
            <!-- Content dynamically injected by renderSidebar() -->
        </div>

        <!-- Main Content Area -->
        <main id="main-content-area" class="flex-grow p-4 md:p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto space-y-8">
                <!-- Content dynamically injected by render() -->
            </div>
        </main>
    </div>
</body>
</html>

