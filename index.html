<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Sheet Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for grade coloring */
        .grade-Ap { color: #10B981; font-weight: bold; } /* Green for A+ */
        .grade-F { color: #EF4444; font-weight: bold; } /* Red for F */
        .grade-normal { font-weight: 500; }
        .grade-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .grade-Ap-bg { background-color: #D1FAE5; color: #065F46; }
        .grade-F-bg { background-color: #FEE2E2; color: #991B1B; }
        .hidden-print { display: block; }
        @media print {
            body { background: none; }
            #app-container { margin: 0; box-shadow: none; border-radius: 0; }
            .hidden-print { display: none !important; }
            #print-area { display: block !important; }
        }
    </style>
    <!-- Configure default font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8 bg-white shadow-xl rounded-lg my-8">
        <h1 class="text-3xl font-extrabold text-blue-800 border-b-4 border-blue-100 pb-2 mb-6 hidden-print">
            Academic Grade Sheet Generator
        </h1>

        <!-- Main Application Body -->
        <div id="app">
            <!-- Loading Indicator -->
            <div id="loading" class="text-center p-12 text-blue-500">
                <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-3"></div>
                <p>Loading data and setting up Firebase...</p>
            </div>

            <!-- Main Content (Hidden until loaded) -->
            <div id="content" class="hidden">
                
                <!-- Institution & Exam Details Form -->
                <div class="grid md:grid-cols-2 gap-4 mb-6 p-4 border rounded-lg bg-blue-50/50">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Institution Name</label>
                        <input type="text" id="institution-name" placeholder="E.g., IFER Institute" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" oninput="app.updateDetails()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Examination Name</label>
                        <input type="text" id="exam-name" placeholder="E.g., First Term Examination 2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" oninput="app.updateDetails()">
                    </div>
                </div>

                <!-- Subject Management & Data Input Section -->
                <div class="mb-8 p-4 border rounded-lg">
                    <h2 class="text-xl font-semibold text-blue-700 mb-4">1. Subjects & Data Entry</h2>
                    
                    <div class="flex flex-wrap gap-4 mb-4">
                        <button onclick="app.showSubjectModal()" class="flex-1 bg-green-500 text-white p-2 rounded-lg shadow hover:bg-green-600 transition min-w-[150px]"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> Add/Manage Subjects</button>
                        <label for="excel-upload" class="flex-1 text-center cursor-pointer bg-blue-500 text-white p-2 rounded-lg shadow hover:bg-blue-600 transition min-w-[150px]"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Upload Excel Data</label>
                        <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" class="hidden" onchange="app.handleFileUpload(event)">
                        <button onclick="app.showStudentModal()" class="flex-1 bg-indigo-500 text-white p-2 rounded-lg shadow hover:bg-indigo-600 transition min-w-[150px]"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0118 15v3h-2zM4.75 12.094A5.973 5.973 0 004 15v3H2v-3a3 3 0 012.75-2.906z" /></svg> Add New Student</button>
                    </div>

                    <!-- Students and Marks Table -->
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Stream</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[50px]">Action</th>
                                    <!-- Dynamic Subject Headers -->
                                    <tbody id="subject-headers"></tbody>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">Rank</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">Percent</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">Report</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Student rows will be injected here -->
                                <tr id="empty-data-row" class="text-center"><td colspan="99" class="p-4 text-gray-500">No student data or subjects yet. Start by adding a subject!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Download Section -->
                <div class="mt-8 p-4 border rounded-lg bg-gray-50">
                    <h2 class="text-xl font-semibold text-blue-700 mb-4">2. Download & Export</h2>
                    <div class="flex flex-wrap gap-4">
                        <div class="flex flex-col flex-1 min-w-[200px] border p-3 rounded-lg bg-white">
                            <h3 class="font-medium mb-2">Whole Marksheet</h3>
                            <button onclick="app.downloadReport('excel', 'all')" class="bg-purple-600 text-white p-2 rounded-lg shadow hover:bg-purple-700 transition mb-2">Download Excel</button>
                            <button onclick="app.downloadReport('pdf', 'all')" class="bg-red-600 text-white p-2 rounded-lg shadow hover:bg-red-700 transition">Download PDF</button>
                        </div>
                        <div class="flex flex-col flex-1 min-w-[200px] border p-3 rounded-lg bg-white">
                            <h3 class="font-medium mb-2">All Individual Reports</h3>
                            <button onclick="app.downloadReport('pdf', 'all_reports')" class="bg-teal-600 text-white p-2 rounded-lg shadow hover:bg-teal-700 transition">Download PDF Bundle</button>
                        </div>
                        <div class="flex flex-col flex-1 min-w-[200px] border p-3 rounded-lg bg-white">
                            <h3 class="font-medium mb-2">Specific Student Report</h3>
                            <select id="student-select" class="p-2 border rounded-md mb-2 w-full"></select>
                            <button onclick="app.downloadReport('pdf', 'selected_report')" class="bg-orange-600 text-white p-2 rounded-lg shadow hover:bg-orange-700 transition">Download Selected PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL: Subject Management -->
            <div id="subject-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-xl font-bold text-blue-700">Manage Subjects</h3>
                        <button onclick="app.hideSubjectModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>

                    <div id="current-subjects-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto p-2 border rounded-md">
                        <!-- Current subjects displayed here -->
                    </div>

                    <h4 class="font-semibold text-lg mb-2">Add New Subject</h4>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <input type="text" id="new-subject-name" placeholder="Subject Name (e.g., Biology)" class="col-span-2 p-2 border rounded-md">
                        <input type="number" id="new-subject-out-of" placeholder="Out Of Mark" value="100" min="1" class="p-2 border rounded-md">
                    </div>
                    <!-- Sub-Subject Option (Advanced) -->
                    <!-- I'll skip implementing sub-subjects in the UI for mark entry complexity, but the data structure supports it.
                         The user can simply make the sub-subjects the main subjects for simplicity. -->

                    <button onclick="app.addSubject()" class="w-full bg-green-500 text-white p-2 rounded-lg shadow hover:bg-green-600 transition">Add Subject</button>
                </div>
            </div>

            <!-- MODAL: Student Management -->
            <div id="student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-xl font-bold text-blue-700">Add New Student</h3>
                        <button onclick="app.hideStudentModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>

                    <label class="block text-sm font-medium text-gray-700 mt-2">Student Name</label>
                    <input type="text" id="new-student-name" placeholder="Student Name" class="mt-1 block w-full p-2 border rounded-md">

                    <label class="block text-sm font-medium text-gray-700 mt-4">Stream</label>
                    <select id="new-student-stream" class="mt-1 block w-full p-2 border rounded-md">
                        <option value="Biology Science">Biology Science</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Commerce">Commerce</option>
                        <option value="Other">Other</option>
                    </select>
                    
                    <label class="block text-sm font-medium text-gray-700 mt-4">Student Photo (Optional)</label>
                    <input type="file" id="new-student-photo" accept="image/*" class="mt-1 block w-full text-sm">

                    <button onclick="app.addStudent()" class="w-full bg-indigo-500 text-white p-2 rounded-lg shadow hover:bg-indigo-600 transition mt-6">Add Student</button>
                </div>
            </div>

            <!-- MODAL/AREA: Individual Student Report Viewer (hidden/used for PDF) -->
            <div id="report-view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
                    <button onclick="app.hideReportModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl hidden-print">&times;</button>
                    <div id="print-area" class="p-4">
                        <!-- Report content will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Floating Notification -->
            <div id="notification" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white bg-green-500 hidden transition-opacity duration-300"></div>

        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Excel/PDF Libraries
        // SheetJS for Excel Read/Write (via CDN)
        const scriptSheetJS = document.createElement('script');
        scriptSheetJS.src = "https://cdn.jsdelivr.net/npm/sheetjs@0.18.1/dist/xlsx.full.min.js";
        document.head.appendChild(scriptSheetJS);

        // jsPDF for PDF generation
        const scriptJsPDF = document.createElement('script');
        scriptJsPDF.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
        document.head.appendChild(scriptJsPDF);

        // html2canvas for converting HTML to PDF content
        const scriptHtml2Canvas = document.createElement('script');
        scriptHtml2Canvas.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        document.head.appendChild(scriptHtml2Canvas);


        // Global Variables
        let db;
        let auth;
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Application State
        window.appState = {
            institutionName: "",
            examName: "",
            subjects: [], // { id, name, outOf }
            students: [], // { id, name, stream, photoBase64, marks: { subId: mark } }
            isAuthReady: false,
        };
        
        // --- Firebase & Auth Setup ---

        async function initFirebase() {
            setLogLevel('Debug');
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Firebase configuration failed to load. Data will not be saved.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Listen for auth changes (to handle sign-in result and future changes)
                onAuthStateChanged(auth, async (user) => {
                    // Only load data if a user is available AND the user ID is new/null
                    if (user && user.uid !== userId) {
                        userId = user.uid;
                        await loadData();
                    }

                    if (user) {
                        window.appState.isAuthReady = true;
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('content').classList.remove('hidden');
                    }
                });

                // 2. Perform initial sign-in (mandatory pattern)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">Initialization failed: ${error.message}</p>`;
            }
        }

        // --- Firestore Data Operations ---

        function getMarksheetDocRef() {
            if (!db || !userId) return null;
            const collectionPath = `/artifacts/${appId}/users/${userId}/marksheets`;
            return doc(db, collectionPath, 'main');
        }

        async function loadData() {
            const docRef = getMarksheetDocRef();
            if (!docRef) {
                console.warn("DocRef is null. Authentication might not be complete.");
                return;
            }

            // Real-time listener
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    window.appState.institutionName = data.institution?.name || "";
                    window.appState.examName = data.examName || "";
                    window.appState.subjects = data.subjects || [];
                    window.appState.students = data.students || [];
                    
                    document.getElementById('institution-name').value = window.appState.institutionName;
                    document.getElementById('exam-name').value = window.appState.examName;

                    window.app.calculateResults();
                    window.app.renderApp();
                    window.app.showNotification("Data loaded automatically.", "bg-green-500");
                }
            }, (error) => {
                // Handle permission denied error specifically
                if (error.code === 'permission-denied') {
                    console.error("Firestore Permission Denied. This usually means the user is not authenticated or security rules are restrictive.", error);
                    window.app.showNotification("Permissions Error: Cannot access saved data. Try reloading the page.", "bg-red-500");
                    return;
                }
                console.error("Firestore listen failed:", error);
                window.app.showNotification("Failed to connect to real-time data.", "bg-red-500");
            });
        }

        async function saveData() {
            if (!window.appState.isAuthReady || !db || !userId) return;

            const dataToSave = {
                institution: { name: window.appState.institutionName, logoUrl: 'uploaded:image_0e42ef.jpg-77434ef4-d9f3-4726-ae29-07890c242c23' }, // Placeholder for logo
                examName: window.appState.examName,
                subjects: window.appState.subjects,
                students: window.appState.students.map(s => ({
                    id: s.id,
                    name: s.name,
                    stream: s.stream,
                    photoBase64: s.photoBase64 || null,
                    marks: s.marks,
                })),
                timestamp: new Date().toISOString(),
            };

            try {
                const docRef = getMarksheetDocRef();
                await setDoc(docRef, dataToSave, { merge: true });
                // Notification is handled by the onSnapshot listener, so no need for an extra success message here.
            } catch (error) {
                console.error("Error saving document: ", error);
                window.app.showNotification("Error saving data.", "bg-red-500");
            }
        }

        // --- Grade Logic ---

        function getGradeAndStyle(percentage) {
            let grade, style, bgColor;
            
            if (percentage >= 90) {
                grade = 'A+';
                style = 'grade-Ap';
                bgColor = 'grade-Ap-bg';
            } else if (percentage >= 80) {
                grade = 'A';
                style = 'grade-normal';
                bgColor = 'bg-yellow-100 text-yellow-800';
            } else if (percentage >= 70) {
                grade = 'B+';
                style = 'grade-normal';
                bgColor = 'bg-lime-100 text-lime-800';
            } else if (percentage >= 60) {
                grade = 'B';
                style = 'grade-normal';
                bgColor = 'bg-teal-100 text-teal-800';
            } else if (percentage >= 50) {
                grade = 'C+';
                style = 'grade-normal';
                bgColor = 'bg-cyan-100 text-cyan-800';
            } else if (percentage >= 40) {
                grade = 'C';
                style = 'grade-normal';
                bgColor = 'bg-blue-100 text-blue-800';
            } else if (percentage >= 30) {
                grade = 'D+';
                style = 'grade-normal';
                bgColor = 'bg-orange-100 text-orange-800';
            } else {
                grade = 'F';
                style = 'grade-F';
                bgColor = 'grade-F-bg';
            }
            return { grade, style, bgColor };
        }

        // --- Main App Logic (exposed globally) ---

        window.app = {
            init: initFirebase,
            saveData: saveData,
            getGradeAndStyle: getGradeAndStyle,

            updateDetails() {
                window.appState.institutionName = document.getElementById('institution-name').value;
                window.appState.examName = document.getElementById('exam-name').value;
                window.app.saveData();
            },

            // --- Subject Management ---

            showSubjectModal() {
                document.getElementById('subject-modal').classList.remove('hidden');
                document.getElementById('subject-modal').classList.add('flex');
                window.app.renderSubjectList();
            },

            hideSubjectModal() {
                document.getElementById('subject-modal').classList.add('hidden');
                document.getElementById('subject-modal').classList.remove('flex');
            },

            renderSubjectList() {
                const list = document.getElementById('current-subjects-list');
                list.innerHTML = window.appState.subjects.map(sub => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 border rounded-md">
                        <span class="font-medium">${sub.name} (Out Of: ${sub.outOf})</span>
                        <button onclick="window.app.removeSubject('${sub.id}')" class="text-red-500 hover:text-red-700 font-bold ml-4">Remove</button>
                    </div>
                `).join('');
                if (window.appState.subjects.length === 0) {
                     list.innerHTML = '<p class="text-center text-gray-400">No subjects defined.</p>';
                }
            },

            addSubject() {
                const name = document.getElementById('new-subject-name').value.trim();
                const outOf = parseInt(document.getElementById('new-subject-out-of').value, 10);

                if (!name || isNaN(outOf) || outOf <= 0) {
                    window.app.showNotification("Invalid subject name or out-of mark.", "bg-red-500");
                    return;
                }

                const newSubject = {
                    id: 'sub-' + Date.now(),
                    name: name,
                    outOf: outOf,
                    subSubjects: [] // Placeholder for sub-subjects
                };

                window.appState.subjects.push(newSubject);
                document.getElementById('new-subject-name').value = '';
                document.getElementById('new-subject-out-of').value = '100';

                window.app.calculateResults();
                window.app.saveData();
                window.app.renderSubjectList();
                window.app.showNotification("Subject added!", "bg-green-500");
            },

            removeSubject(subjectId) {
                window.appState.subjects = window.appState.subjects.filter(s => s.id !== subjectId);

                // Remove marks for this subject from all students
                window.appState.students.forEach(student => {
                    delete student.marks[subjectId];
                });

                window.app.calculateResults();
                window.app.saveData();
                window.app.renderSubjectList();
                window.app.showNotification("Subject removed.", "bg-orange-500");
            },
            
            // --- Student Management ---

            showStudentModal() {
                document.getElementById('student-modal').classList.remove('hidden');
                document.getElementById('student-modal').classList.add('flex');
            },

            hideStudentModal() {
                document.getElementById('student-modal').classList.add('hidden');
                document.getElementById('student-modal').classList.remove('flex');
            },

            addStudent() {
                const name = document.getElementById('new-student-name').value.trim();
                const stream = document.getElementById('new-student-stream').value;
                const photoInput = document.getElementById('new-student-photo');

                if (!name) {
                    window.app.showNotification("Please enter a student name.", "bg-red-500");
                    return;
                }

                let photoBase64 = null;
                const file = photoInput.files[0];

                const createStudent = (base64) => {
                    const newStudent = {
                        id: 'stu-' + Date.now(),
                        name: name,
                        stream: stream,
                        photoBase64: base64,
                        marks: {},
                        calculated: { total: 0, percentage: 0, rank: 0, grades: {} }
                    };

                    // Initialize marks for new student
                    window.appState.subjects.forEach(sub => {
                        newStudent.marks[sub.id] = null;
                    });
                    
                    window.appState.students.push(newStudent);
                    window.app.calculateResults();
                    window.app.saveData();
                    window.app.hideStudentModal();
                    document.getElementById('new-student-name').value = '';
                    photoInput.value = '';
                    window.app.showNotification("Student added!", "bg-green-500");
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        createStudent(e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    createStudent(null);
                }
            },

            removeStudent(studentId) {
                // Custom Modal replacement for confirm()
                const confirmed = window.prompt(`Type DELETE to confirm removing this student:`);
                if (confirmed !== 'DELETE') return;

                window.appState.students = window.appState.students.filter(s => s.id !== studentId);
                window.app.calculateResults();
                window.app.saveData();
                window.app.showNotification("Student removed.", "bg-orange-500");
            },

            // --- Excel Upload (Simplified CSV/TSV detection) ---

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        if (json.length < 2) {
                            window.app.showNotification("Excel sheet is empty or has no header.", "bg-red-500");
                            return;
                        }

                        // Assumption: First row is header, subsequent rows are data
                        const headers = json[0].map(h => h.trim());
                        const studentData = json.slice(1);
                        
                        // Detect and set Subjects based on headers (excluding Name, Stream)
                        const subjectHeaders = headers.filter(h => h !== 'Name' && h !== 'Stream' && h !== 'Out Of');
                        if (subjectHeaders.length === 0) {
                             window.app.showNotification("Could not detect subjects (columns other than 'Name' or 'Stream').", "bg-orange-500");
                             return;
                        }
                        
                        // Clear existing subjects and students
                        window.appState.subjects = [];
                        window.appState.students = [];
                        
                        // Create subjects and extract Out Of marks if provided
                        subjectHeaders.forEach(h => {
                            let outOf = 100;
                            // Check if an "Out Of" column exists for this subject, e.g., "Math Out Of"
                            const outOfIndex = headers.findIndex(oh => oh === `${h} Out Of`);
                            if (outOfIndex !== -1) {
                                // Try to find the max mark from the first student row for the "Out Of" column
                                const maxMark = parseInt(studentData[0]?.[outOfIndex], 10);
                                if (!isNaN(maxMark) && maxMark > 0) outOf = maxMark;
                            }
                            
                            window.appState.subjects.push({
                                id: h.replace(/\s/g, '_'),
                                name: h,
                                outOf: outOf,
                                subSubjects: []
                            });
                        });
                        
                        // Populate students
                        studentData.forEach(row => {
                            if (!row[0]) return; // Skip empty rows

                            const studentNameIndex = headers.indexOf('Name');
                            const studentStreamIndex = headers.indexOf('Stream');
                            
                            const newStudent = {
                                id: 'stu-' + crypto.randomUUID(),
                                name: row[studentNameIndex !== -1 ? studentNameIndex : 0]?.toString() || 'Unnamed Student',
                                stream: row[studentStreamIndex !== -1 ? studentStreamIndex : 1]?.toString() || 'Other',
                                photoBase64: null,
                                marks: {},
                                calculated: { total: 0, percentage: 0, rank: 0, grades: {} }
                            };
                            
                            window.appState.subjects.forEach(sub => {
                                const markIndex = headers.indexOf(sub.name);
                                const mark = markIndex !== -1 ? parseFloat(row[markIndex]) : null;
                                newStudent.marks[sub.id] = !isNaN(mark) ? mark : null;
                            });

                            window.appState.students.push(newStudent);
                        });

                        window.app.calculateResults();
                        window.app.saveData();
                        window.app.showNotification(`Successfully loaded ${window.appState.students.length} students and ${window.appState.subjects.length} subjects!`, "bg-green-500");

                    } catch (error) {
                        console.error("Error parsing file:", error);
                        window.app.showNotification("Error processing file. Please ensure it's a valid Excel/CSV.", "bg-red-500");
                    }
                };
                reader.readAsArrayBuffer(file);
            },


            // --- Core Calculation ---

            calculateResults() {
                const totalPossible = window.appState.subjects.reduce((sum, sub) => sum + sub.outOf, 0);

                window.appState.students.forEach(student => {
                    let studentTotal = 0;
                    let studentTotalObtained = 0;
                    let hasValidMarks = false;

                    // Calculate subject grades and student total marks
                    student.calculated.grades = {};
                    window.appState.subjects.forEach(sub => {
                        const mark = student.marks[sub.id];
                        if (typeof mark === 'number' && mark >= 0) {
                            hasValidMarks = true;
                            studentTotalObtained += mark;
                            
                            const percentage = (mark / sub.outOf) * 100;
                            student.calculated.grades[sub.id] = window.app.getGradeAndStyle(percentage).grade;
                        } else {
                            // If a mark is missing, the total mark possible might decrease for this student if needed,
                            // but for ranking simplicity, we'll keep the overall total possible the same.
                            // However, we set the grade to N/A.
                            student.calculated.grades[sub.id] = 'N/A';
                        }
                    });
                    
                    student.calculated.total = studentTotalObtained;
                    student.calculated.percentage = totalPossible > 0 && hasValidMarks ? 
                        (studentTotalObtained / totalPossible) * 100 : 0;
                });

                // 1. Sort students by Total Mark (descending)
                window.appState.students.sort((a, b) => b.calculated.total - a.calculated.total);

                // 2. Calculate Rank
                if (window.appState.students.length > 0) {
                    window.appState.students[0].calculated.rank = 1;
                    for (let i = 1; i < window.appState.students.length; i++) {
                        // Handle tie rank (students with the same total get the same rank)
                        if (window.appState.students[i].calculated.total === window.appState.students[i-1].calculated.total) {
                            window.appState.students[i].calculated.rank = window.appState.students[i-1].calculated.rank;
                        } else {
                            window.appState.students[i].calculated.rank = i + 1;
                        }
                    }
                }
                
                window.app.renderApp();
            },

            // --- Render UI ---

            renderApp() {
                // 1. Render Subject Headers
                const headerHTML = window.appState.subjects.map(sub => `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px] whitespace-nowrap">
                        ${sub.name}<br/>(Out Of: ${sub.outOf})
                    </th>
                `).join('');
                document.getElementById('subject-headers').innerHTML = headerHTML;
                
                // 2. Render Student Rows
                const tbody = document.getElementById('students-table-body');
                
                if (window.appState.students.length === 0 && window.appState.subjects.length === 0) {
                    document.getElementById('empty-data-row').classList.remove('hidden');
                    tbody.innerHTML = '';
                    tbody.appendChild(document.getElementById('empty-data-row'));
                } else {
                    document.getElementById('empty-data-row').classList.add('hidden');
                    tbody.innerHTML = window.appState.students.map((student, index) => {
                        
                        // Generate Mark and Grade cells
                        const markCells = window.appState.subjects.map(sub => {
                            const mark = student.marks[sub.id];
                            const grade = student.calculated.grades[sub.id];
                            const percentage = sub.outOf > 0 ? (mark / sub.outOf) * 100 : 0;
                            const { style, bgColor } = window.app.getGradeAndStyle(percentage);
                            
                            const markValue = typeof mark === 'number' && mark >= 0 ? mark : 'N/A';

                            return `
                                <td class="px-3 py-4 whitespace-nowrap">
                                    <div class="flex flex-col items-center">
                                        <input type="number" min="0" max="${sub.outOf}" value="${markValue === 'N/A' ? '' : markValue}" 
                                            class="w-20 p-1 border rounded-md text-center text-sm focus:ring-blue-500 focus:border-blue-500"
                                            oninput="window.app.updateMark('${student.id}', '${sub.id}', this.value)">
                                        <span class="text-xs ${style} grade-badge mt-1 ${bgColor}">${grade}</span>
                                    </div>
                                </td>
                            `;
                        }).join('');

                        const totalPercent = student.calculated.percentage.toFixed(2);
                        
                        return `
                            <tr class="hover:bg-blue-50/50">
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${student.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.stream}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="window.app.removeStudent('${student.id}')" class="text-red-500 hover:text-red-700">Delete</button>
                                </td>
                                ${markCells}
                                <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900">${student.calculated.total}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-lg font-extrabold text-blue-600">${student.calculated.rank}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-700">${totalPercent}%</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="window.app.showIndividualReport('${student.id}')" class="text-indigo-600 hover:text-indigo-900 p-2 border rounded-md hover:bg-indigo-50 transition">View Report</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // 3. Update Download Student Select
                const select = document.getElementById('student-select');
                select.innerHTML = '<option value="">-- Select Student --</option>' + window.appState.students.map(s => `
                    <option value="${s.id}">${s.name} (Rank ${s.calculated.rank})</option>
                `).join('');
            },

            updateMark(studentId, subjectId, value) {
                const student = window.appState.students.find(s => s.id === studentId);
                const subject = window.appState.subjects.find(s => s.id === subjectId);
                const mark = value === '' ? null : parseFloat(value);
                
                if (student && subject) {
                    if (mark > subject.outOf) {
                        window.app.showNotification(`Mark cannot exceed ${subject.outOf} for ${subject.name}.`, "bg-red-500");
                        return;
                    }
                    student.marks[subjectId] = mark;
                    window.app.calculateResults();
                    window.app.saveData();
                }
            },

            // --- Reporting & PDF/Excel Download ---

            generateReportHTML(student) {
                const totalPossible = window.appState.subjects.reduce((sum, sub) => sum + sub.outOf, 0);
                const totalStudents = window.appState.students.length;
                const date = new Date().toLocaleDateString();

                const institutionLogo = 'uploaded:image_0e42ef.jpg-77434ef4-d9f3-4726-ae29-07890c242c23'; // The uploaded logo
                
                const reportContent = `
                    <div class="report-document p-6 border-4 border-double border-blue-700 rounded-xl">
                        
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-6 border-b pb-4 border-gray-200">
                            <div class="flex items-center">
                                <img src="${institutionLogo}" onerror="this.style.display='none'" class="h-16 w-16 object-contain mr-4 rounded-lg">
                                <div>
                                    <h1 class="text-2xl font-extrabold text-blue-800">${window.appState.institutionName || 'INSTITUTION NAME'}</h1>
                                    <p class="text-sm text-gray-500">Academic Progress Report</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-gray-700">${window.appState.examName || 'Examination Name'}</p>
                                <p class="text-sm text-gray-500">Date: ${date}</p>
                            </div>
                        </div>

                        <!-- Student Info -->
                        <div class="flex justify-between items-center mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <div class="flex-1">
                                <p class="text-xl font-bold text-gray-800">Student: ${student.name}</p>
                                <p class="text-md text-gray-600">Stream: ${student.stream}</p>
                                <p class="text-md text-gray-600">User ID: ${student.id}</p>
                            </div>
                            ${student.photoBase64 ? `<img src="${student.photoBase64}" class="h-20 w-20 object-cover rounded-full shadow-md ml-4" alt="Student Photo">` : ''}
                        </div>

                        <!-- Results Table -->
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full divide-y divide-gray-200 border">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Subject</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 uppercase">Max Marks</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 uppercase">Marks Obtained</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 uppercase">Percentage</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 uppercase">Grade</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${window.appState.subjects.map(sub => {
                                        const mark = student.marks[sub.id];
                                        const markValue = typeof mark === 'number' && mark >= 0 ? mark : 'N/A';
                                        const percentage = typeof mark === 'number' && sub.outOf > 0 ? (mark / sub.outOf) * 100 : 0;
                                        const gradeInfo = window.app.getGradeAndStyle(percentage);
                                        
                                        return `
                                            <tr>
                                                <td class="px-4 py-2 whitespace-nowrap font-medium text-gray-900">${sub.name}</td>
                                                <td class="px-4 py-2 whitespace-nowrap text-center text-gray-600">${sub.outOf}</td>
                                                <td class="px-4 py-2 whitespace-nowrap text-center font-bold text-gray-800">${markValue}</td>
                                                <td class="px-4 py-2 whitespace-nowrap text-center text-gray-600">${markValue === 'N/A' ? 'N/A' : percentage.toFixed(1) + '%'}</td>
                                                <td class="px-4 py-2 whitespace-nowrap text-center">
                                                    <span class="grade-badge ${gradeInfo.bgColor} ${gradeInfo.style}">${gradeInfo.grade}</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Summary -->
                        <div class="grid grid-cols-2 gap-4 text-center border-t-2 border-dashed pt-4">
                            <div class="p-3 bg-indigo-100 rounded-lg">
                                <p class="text-sm font-medium text-indigo-700">Total Marks Obtained</p>
                                <p class="text-3xl font-extrabold text-indigo-900">${student.calculated.total} / ${totalPossible}</p>
                            </div>
                            <div class="p-3 bg-red-100 rounded-lg">
                                <p class="text-sm font-medium text-red-700">Overall Percentage</p>
                                <p class="text-3xl font-extrabold text-red-900">${student.calculated.percentage.toFixed(2)}%</p>
                            </div>
                            <div class="col-span-2 p-3 bg-green-100 rounded-lg">
                                <p class="text-sm font-medium text-green-700">Class Rank (Overall)</p>
                                <p class="text-4xl font-extrabold text-green-900">#${student.calculated.rank} <span class="text-lg font-normal">out of ${totalStudents} students</span></p>
                            </div>
                        </div>

                        <p class="text-xs text-gray-400 mt-6 text-center">** This is a computer-generated report and does not require a signature. **</p>
                    </div>
                `;
                return reportContent;
            },
            
            showIndividualReport(studentId) {
                const student = window.appState.students.find(s => s.id === studentId);
                if (!student) return;

                const reportHTML = window.app.generateReportHTML(student);
                document.getElementById('print-area').innerHTML = reportHTML;
                document.getElementById('report-view-modal').classList.remove('hidden');
                document.getElementById('report-view-modal').classList.add('flex');
            },
            
            hideReportModal() {
                 document.getElementById('report-view-modal').classList.add('hidden');
                 document.getElementById('report-view-modal').classList.remove('flex');
            },

            async downloadReport(format, scope) {
                if (window.appState.students.length === 0) {
                     window.app.showNotification("No student data to download.", "bg-red-500");
                     return;
                }
                
                window.app.showNotification("Preparing download...", "bg-blue-500");

                if (format === 'excel') {
                    if (scope === 'all') {
                        await window.app.downloadExcelMarksheet();
                    }
                } else if (format === 'pdf') {
                    if (scope === 'all') {
                        // PDF of the main marksheet table
                        window.app.downloadTablePDF();
                    } else if (scope === 'all_reports') {
                        await window.app.downloadAllReportsPDF();
                    } else if (scope === 'selected_report') {
                        const studentId = document.getElementById('student-select').value;
                        if (!studentId) {
                            window.app.showNotification("Please select a student first.", "bg-red-500");
                            return;
                        }
                        await window.app.downloadSelectedReportPDF(studentId);
                    }
                }
                window.app.showNotification("Download complete!", "bg-green-500");
            },

            // --- Download Implementations ---

            async downloadExcelMarksheet() {
                const header = [
                    'Rank', 'Student Name', 'Stream', 'Total Mark', 'Percentage', 
                    ...window.appState.subjects.flatMap(s => [s.name, `${s.name} Grade`, `${s.name} Out Of`])
                ];

                const data = window.appState.students.map(s => {
                    const row = [
                        s.calculated.rank, 
                        s.name, 
                        s.stream, 
                        s.calculated.total, 
                        s.calculated.percentage.toFixed(2) + '%'
                    ];
                    window.appState.subjects.forEach(sub => {
                        const mark = s.marks[sub.id];
                        row.push(mark);
                        row.push(s.calculated.grades[sub.id] || 'N/A');
                        row.push(sub.outOf);
                    });
                    return row;
                });
                
                const ws_data = [
                    [`Institution: ${window.appState.institutionName}`, `Exam: ${window.appState.examName}`],
                    [''],
                    header,
                    ...data
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                
                // Styling (simple attempt - XLSX.js focuses more on data)
                ws['!cols'] = [{ wch: 5 }, { wch: 20 }, { wch: 15 }];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Class Marksheet");
                XLSX.writeFile(wb, `${window.appState.examName}_Marksheet.xlsx`);
            },
            
            async downloadTablePDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                // Logo & Header (Basic PDF Header)
                doc.setFontSize(14);
                doc.setTextColor(30, 64, 175); // Blue
                doc.text(window.appState.institutionName, 14, 15);
                doc.setFontSize(12);
                doc.setTextColor(55, 65, 81); // Gray
                doc.text(`${window.appState.examName} - Class Marksheet`, 14, 22);
                
                // Get the main table element
                const element = document.querySelector('table'); 
                
                if (element) {
                    doc.autoTable({
                        html: element,
                        startY: 30,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246] },
                        didDrawPage: function (data) {
                            // Footer
                            doc.setFontSize(10);
                            doc.text(`Generated by Grade Sheet Generator - ${new Date().toLocaleDateString()}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                        }
                    });
                    doc.save(`${window.appState.examName}_Marksheet_Table.pdf`);
                } else {
                    window.app.showNotification("Could not find table element for PDF.", "bg-red-500");
                }
            },

            async downloadReportPDF(student, filename) {
                const { jsPDF } = window.jspdf;
                const reportHTML = window.app.generateReportHTML(student);
                document.getElementById('print-area').innerHTML = reportHTML;
                
                // Use html2canvas to render the HTML report to a canvas
                const canvas = await html2canvas(document.querySelector("#print-area .report-document"), {
                    scale: 3, // High scale for better resolution
                    logging: false,
                    useCORS: true,
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                let heightLeft = imgHeight;
                
                const doc = new jsPDF('p', 'mm', 'a4');
                let position = 0;

                // Add the image to the PDF
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Handle multi-page content if the image is too long (though usually not for one report)
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(filename);
            },
            
            async downloadSelectedReportPDF(studentId) {
                const student = window.appState.students.find(s => s.id === studentId);
                if (student) {
                    await window.app.downloadReportPDF(student, `${student.name}_${window.appState.examName}_Report.pdf`);
                    document.getElementById('print-area').innerHTML = ''; // Clear report area
                }
            },
            
            async downloadAllReportsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageHeight = 297; 
                let firstPage = true;

                for (const student of window.appState.students) {
                    if (!firstPage) {
                        doc.addPage();
                    }
                    
                    const reportHTML = window.app.generateReportHTML(student);
                    document.getElementById('print-area').innerHTML = reportHTML;

                    const reportElement = document.querySelector("#print-area .report-document");
                    
                    const canvas = await html2canvas(reportElement, {
                        scale: 3,
                        logging: false,
                        useCORS: true,
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    
                    firstPage = false;
                }
                
                doc.save(`${window.appState.examName}_All_Reports_Bundle.pdf`);
                document.getElementById('print-area').innerHTML = ''; // Clear report area
            },

            // --- Utility ---
            showNotification(message, colorClass) {
                const notif = document.getElementById('notification');
                notif.textContent = message;
                notif.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white ${colorClass} transition-opacity duration-300`;
                notif.classList.remove('hidden');

                setTimeout(() => {
                    notif.classList.add('opacity-0');
                    setTimeout(() => {
                        notif.classList.add('hidden');
                        notif.classList.remove('opacity-0');
                    }, 300);
                }, 3000);
            }
        };

        window.onload = window.app.init;
    </script>
</body>
</html>






