<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Gradebook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .table-input {
            width: 60px;
            padding: 4px 8px;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .table-input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .table-input:disabled {
            background-color: #F3F4F6;
            cursor: not-allowed;
        }
        .table-row-selected {
            background-color: #EEF2FF;
        }
        .student-photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #E0E7FF;
        }
        .default-photo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F3F4F6;
            color: #D1D5DB;
            font-size: 50px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals with Indigo Accent -->
    <!-- Application Structure Plan: A two-column dashboard layout remains the core structure. A new 'Header/Branding' section is added at the top for Institution details and the Exam Name. The left column features the dynamic, editable table, which now includes subject grades. The right column displays the detailed progress report and radar chart for a selected student. A new 'Photo Manager' block is added to the configuration area to handle student image uploads. The 'Subject Configuration & Data Management' section is expanded to include a manual 'Add Student' form and now allows dynamic subject removal via buttons. This structure is chosen to neutralize configuration (top), provide a comprehensive overview (left), and offer deep-dive analysis (right), making the tool highly interactive and reflective of the source report's core calculation needs. -->
    <!-- Visualization & Content Choices: 
        1. Branding Header: Report Info -> Institution Name, Logo, Exam Name. Goal -> Professional presentation & context. Viz/Method -> Fixed header block with responsive image (logo) and input field (Exam Name). Interaction -> Typing in the exam name updates the report headers instantly via JS. Justification -> Provides essential report context and branding as requested.
        2. Photo Manager: Report Info -> Student Photos. Goal -> Personalization of reports. Viz/Method -> Dropdown and File Input. Interaction -> Uploads are converted to Base64 and stored, then displayed on the report card. Justification -> Addresses the user request for optional student photos.
        3. Subject Configuration: Report Info -> Subject names and Max Marks (now dynamic), now supports Excel upload, manual student entry, and dynamic removal. Goal -> Allow user configuration and bulk/manual data entry. Viz/Method -> Dynamic HTML form inputs and File Input/Buttons. Interaction -> Removal buttons instantly update subjects and data. Justification -> Addresses the user request for manual student addition and subject removal.
        4. Class Data: Report Info -> All student marks, subject grades, and overall stats. Goal -> Organize, Compare. Viz/Method -> Interactive HTML Table with number inputs and dynamic columns. Interaction -> Editing marks or configuration triggers recalculation, re-ranking, and dynamic grade color-coding (A+/F colors). Justification -> Simulates the core dynamic spreadsheet functionality with enhanced visual feedback.
        5. Individual Performance: Report Info -> Single student's metrics. Goal -> Inform, Analyze. Viz/Method -> Styled card and Chart.js Radar Chart. Interaction -> Updates on student selection. Justification -> Radar chart dynamically shows performance across all configured subjects.
        6. Download Options: Goal -> Export data for specified student (PDF) and whole class (Excel). Viz/Method -> Dedicated buttons calling JS functions. Interaction -> Triggers Excel download or Print dialogue. Justification -> Addresses user request for export functionality in multiple formats.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- INSTITUTION AND EXAM HEADER -->
        <header class="bg-white p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img src="image_0e42ef.jpg" alt="Ifer Logo" class="h-12 w-12 object-contain rounded-lg">
                <div class="text-left">
                    <h1 id="institution-name" class="text-xl sm:text-2xl font-bold text-gray-900">Ifer Academy</h1>
                    <p id="institution-tagline" class="text-sm text-gray-600">Better Education, Better Society</p>
                </div>
            </div>
            <div class="text-center md:text-right w-full md:w-auto">
                <p class="text-sm font-medium text-gray-500 mb-1">Examination Name</p>
                <input type="text" id="exam-name-input" placeholder="e.g., Final Term Exam 2024" value="First Mid-Term Examination" class="table-input !w-full md:!w-64 !text-center !py-2 !px-3 text-base font-semibold" />
            </div>
        </header>

        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 tracking-tight">Dynamic Student Mark Sheet</h1>
            <p id="main-exam-display" class="mt-2 text-lg text-indigo-600 font-semibold"></p>
        </header>

        <section id="subject-management" class="mb-8 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Subject Configuration & Data Management</h2>
            <p class="text-gray-600 mb-4">You can manually define subjects below or **upload an Excel file** to load all student marks automatically.</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Excel Upload Option -->
                <div class="p-4 border border-indigo-200 bg-indigo-50 rounded-lg col-span-1 lg:col-span-2">
                    <label for="excel-upload" class="font-semibold text-indigo-700 block mb-2">Upload Mark Sheet (Excel)</label>
                    <input type="file" id="excel-upload" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-200 file:text-indigo-800
                        hover:file:bg-indigo-300
                    "/>
                    <p class="text-xs text-indigo-700 mt-2">**Flexible Format:** Automatically detects common column headers like 'ID', 'Roll No', 'Name', 'Student Name', etc.</p>
                </div>

                <!-- Student Photo Upload Option -->
                <div class="p-4 border border-gray-200 bg-gray-50 rounded-lg">
                    <label class="font-semibold text-gray-700 block mb-2">Student Photo Manager</label>
                    <select id="photo-student-select" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm mb-3">
                        <option value="">-- Select Student --</option>
                    </select>
                    <input type="file" id="photo-upload-input" accept="image/jpeg, image/png" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-1 file:px-3
                        file:rounded-full file:border-0
                        file:text-xs file:font-semibold
                        file:bg-gray-200 file:text-gray-700
                        hover:file:bg-gray-300
                    "/>
                </div>
            </div>

            <!-- Manual Student Addition -->
            <div class="p-4 mt-6 border border-gray-200 bg-gray-50 rounded-lg grid grid-cols-1 sm:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
                
                <div class="col-span-1">
                    <label for="new-student-id" class="text-sm font-medium text-gray-700 block mb-1">New Student ID</label>
                    <input type="text" id="new-student-id" placeholder="e.g., S011" class="table-input !w-full !text-left !py-2 !px-3" />
                </div>
                 <div class="col-span-2 lg:col-span-1">
                    <label for="new-student-name" class="text-sm font-medium text-gray-700 block mb-1">New Student Name</label>
                    <input type="text" id="new-student-name" placeholder="e.g., Sarah Johnson" class="table-input !w-full !text-left !py-2 !px-3" />
                </div>
                
                <div class="col-span-1 lg:col-span-1">
                    <label for="new-student-stream" class="text-sm font-medium text-gray-700 block mb-1">Stream</label>
                    <select id="new-student-stream" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="General Stream">General Stream</option>
                        <option value="Biology Science">Biology Science</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Commerce">Commerce</option>
                    </select>
                </div>

                <button id="add-student-btn-manual" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md col-span-1 lg:col-span-2">
                    + Add New Student
                </button>
            </div>


            <h3 class="text-xl font-semibold mb-3 text-gray-800 pt-4 border-t border-gray-100 mt-6">Max Marks & Subject Editor</h3>
            
            <div id="subject-config-inputs" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- Subject Max Mark Inputs will be rendered here -->
            </div>
            
            <div class="flex flex-col sm:flex-row items-center gap-4 pt-4 border-t border-gray-100">
                <input type="text" id="new-subject-name" placeholder="New Subject Name (e.g., History)" class="table-input w-full sm:w-64 !text-left !w-auto !py-2 !px-3" />
                <button id="add-subject-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    + Add Subject
                </button>
            </div>

            <!-- Data Persistence Warning and Clear Button -->
            <div class="p-4 mt-6 border border-red-200 bg-red-50 rounded-lg col-span-full">
                <h4 class="text-sm font-bold text-red-800 mb-2">Data Persistence (Saved Automatically in Browser)</h4>
                <p class="text-xs text-red-700 mb-3">All application data (students, marks, subjects) is automatically saved to your browser's local storage. This data will remain until you clear your browser history or use the button below.</p>
                
                <div id="clear-data-prompt" class="hidden text-sm mb-2 text-red-800 font-medium">
                    Are you sure? This action is permanent. Click again to confirm.
                </div>
                <button id="clear-data-btn" data-confirm="false" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md text-sm">
                    🗑️ Clear All Saved Data
                </button>
            </div>
        </section>

        <main class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            
            <section id="class-data-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Class Performance Overview</h2>
                        <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md text-sm">
                            ⬇️ Download Class Data (Excel)
                        </button>
                    </div>
                    <p class="text-gray-600 mb-4">Click on a student to view their detailed report. Edit marks directly in the table to see ranks update in real-time. Subject grades are color-coded.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr id="table-headers">
                                    <!-- Dynamic headers will be inserted here by JavaScript -->
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="progress-report-section">
                <div id="report-card-container" class="bg-white p-6 rounded-lg shadow-md sticky top-8">
                    <div id="report-placeholder">
                        <h2 class="text-2xl font-semibold text-gray-800">Student Progress Report</h2>
                        <p class="text-gray-600 mt-4">Select a student from the table or upload an Excel file to view data.</p>
                    </div>
                    <div id="report-content" class="hidden">
                        
                        <!-- REPORT HEADER WITH INSTITUTION/EXAM DETAILS -->
                        <div class="border-b pb-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <img src="image_0e42ef.jpg" alt="Ifer Logo" class="h-8 w-8 object-contain rounded-md">
                                    <h3 class="text-lg font-bold text-gray-900" id="report-institution-name">Ifer Institute of Education</h3>
                                </div>
                                <p class="text-sm font-medium text-gray-600" id="report-exam-name"></p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row justify-between items-start border-b pb-4 mb-4">
                            <!-- Student Photo and Details -->
                            <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                                <div class="student-photo-preview flex-shrink-0" id="report-photo-container">
                                    <!-- Photo or default icon goes here -->
                                </div>
                                <div>
                                    <h2 id="report-student-name" class="text-2xl font-bold text-indigo-600"></h2>
                                    <p id="report-student-id" class="text-sm text-gray-500"></p>
                                    <p id="report-student-stream" class="text-sm font-medium text-gray-700 mt-1"></p>
                                </div>
                            </div>
                             <!-- Rank -->
                             <div class="text-right self-center sm:self-auto">
                                <p class="text-lg font-semibold text-gray-600">Class Rank</p>
                                <p id="report-rank" class="text-3xl font-bold text-gray-900"></p>
                            </div>
                        </div>

                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">Total Marks</p>
                                <p id="report-total" class="text-2xl font-semibold text-gray-900"></p>
                            </div>
                             <div class="bg-gray-100 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">Percentage</p>
                                <p id="report-percentage" class="text-2xl font-semibold text-gray-900"></p>
                            </div>
                             <div class="bg-gray-100 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">Overall Grade</p>
                                <p id="report-grade" class="text-2xl font-semibold text-gray-900"></p>
                            </div>
                        </div>

                        <!-- Subsubject Details Table -->
                        <div id="subsubject-details-container" class="mt-8">
                             <h3 class="text-lg font-semibold text-gray-800 mb-2">Detailed Subject Breakdown</h3>
                             <!-- Details will be injected here -->
                        </div>

                        <div class="mt-8">
                             <h3 class="text-lg font-semibold text-gray-800 mb-2">Subject Performance Radar</h3>
                             <div class="chart-container">
                                <canvas id="progress-chart"></canvas>
                             </div>
                        </div>

                        <!-- NEW PRINT BUTTON FOR INDIVIDUAL REPORT -->
                        <button id="print-individual-report-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            🖨️ Print/Save as PDF Report
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Calculation Logic & Detailed Grading Scale</h3>
                <p class="text-gray-600 mb-4">The grades and ranks are calculated automatically based on the subject's maximum marks and the detailed grading scale below. **Badges are colored to highlight only A+ (Green) and F (Red) grades.**</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700">Detailed Grading Scale</h4>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1">
                            <li><span class="font-medium text-green-700">A+</span>: 90% and above (Badge: Green)</li>
                            <li><span class="font-medium text-indigo-700">A</span>: 80% to 89.99% (Badge: Indigo)</li>
                            <li><span class="font-medium text-indigo-700">B+</span>: 70% to 79.99% (Badge: Indigo)</li>
                            <li><span class="font-medium text-indigo-700">B</span>: 60% to 69.99% (Badge: Indigo)</li>
                            <li><span class="font-medium text-indigo-700">C+</span>: 50% to 59.99% (Badge: Indigo)</li>
                            <li><span class="font-medium text-indigo-700">C</span>: 40% to 49.99% (Badge: Indigo)</li>
                            <li><span class="font-medium text-indigo-700">D+</span>: 30% to 39.99% (Badge: Indigo)</li>
                            <li><span class="font-medium text-red-600">F</span>: Below 30% (Badge: Red)</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Ranking Method</h4>
                        <p class="mt-2 text-gray-600">The class rank is determined using the `RANK.EQ` logic based on the overall percentage, where the student with the highest percentage receives Rank 1. Ties share the same rank.</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Subsubject Editor Modal -->
    <div id="subsubject-editor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Manage Subsubjects for: <span id="current-subject-name" class="text-indigo-600"></span></h3>
            
            <p class="text-sm text-gray-600 mb-3">Define the components (Theory, Practical, Exam, etc.) and their maximum marks. The sum of subsubjects will become the main subject's total max mark.</p>

            <div id="subsubject-list" class="space-y-3 mb-6 p-4 border rounded-lg bg-gray-50 max-h-60 overflow-y-auto">
                <!-- Subsubject inputs will be rendered here -->
            </div>

            <div class="flex items-center space-x-3 border-t pt-4">
                <input type="text" id="new-subsubject-name" placeholder="New Subsubject Name (e.g., Theory)" class="table-input w-full !text-left !py-2 !px-3" />
                <input type="number" id="new-subsubject-max" min="1" value="50" placeholder="Max Marks" class="table-input w-24 !text-left !py-2 !px-3" />
                <button id="add-subsubject-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md flex-shrink-0">
                    + Add
                </button>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="close-modal-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Close & Apply Changes
                </button>
            </div>
        </div>
    </div>
    <!-- End Subsubject Editor Modal -->

    <script>
        // Data Storage Key
        const STORAGE_KEY = 'gradebook_app_state';

        // Initial default data
        let subjectsConfig = [
            { key: 'physics', name: 'Physics', maxMarks: 100, subSubjects: [] },
            { key: 'chemistry', name: 'Chemistry', maxMarks: 100, subSubjects: [] },
            { key: 'biology', name: 'Biology', maxMarks: 100, subSubjects: [] }
        ];

        let studentsData = [];
        let selectedStudentId = null;
        let progressChart = null;
        let currentSubjectKey = null; // Used by the Subsubject Editor Modal
        
        const DEFAULT_STREAM = "General Stream"; 

        const tableBody = document.getElementById('students-table-body');
        const tableHeadersRow = document.getElementById('table-headers');
        const reportPlaceholder = document.getElementById('report-placeholder');
        const reportContent = document.getElementById('report-content');
        const subjectConfigInputs = document.getElementById('subject-config-inputs');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const newSubjectNameInput = document.getElementById('new-subject-name');
        const examNameInput = document.getElementById('exam-name-input');
        const mainExamDisplay = document.getElementById('main-exam-display');
        const reportExamName = document.getElementById('report-exam-name');
        const excelUploadInput = document.getElementById('excel-upload');
        const photoUploadInput = document.getElementById('photo-upload-input');
        const photoStudentSelect = document.getElementById('photo-student-select');
        const newStudentIdInput = document.getElementById('new-student-id');
        const newStudentNameInput = document.getElementById('new-student-name');
        const newStudentStreamInput = document.getElementById('new-student-stream');
        const addStudentManuallyBtn = document.getElementById('add-student-btn-manual');
        const downloadReportBtn = document.getElementById('download-report-btn');
        const printIndividualReportBtn = document.getElementById('print-individual-report-btn');

        // Subsubject Modal Elements
        const subsubjectEditorModal = document.getElementById('subsubject-editor-modal');
        const currentSubjectNameSpan = document.getElementById('current-subject-name');
        const subsubjectListDiv = document.getElementById('subsubject-list');
        const newSubsubjectNameInput = document.getElementById('new-subsubject-name');
        const newSubsubjectMaxInput = document.getElementById('new-subsubject-max');
        const addSubsubjectBtn = document.getElementById('add-subsubject-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');


        // --- DATA PERSISTENCE FUNCTIONS ---
        
        const saveState = () => {
            try {
                const state = {
                    students: studentsData,
                    subjects: subjectsConfig,
                    examName: examNameInput.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        };

        const loadState = () => {
            try {
                const serializedState = localStorage.getItem(STORAGE_KEY);
                if (serializedState) {
                    const state = JSON.parse(serializedState);
                    
                    if (state.students && Array.isArray(state.students)) {
                        studentsData = state.students;
                    }

                    if (state.subjects && Array.isArray(state.subjects)) {
                        subjectsConfig = state.subjects;
                        // Ensure all loaded subjects have the subSubjects array for consistency
                        subjectsConfig.forEach(sub => {
                            if (!sub.subSubjects) sub.subSubjects = [];
                            // Ensure marks are objects for subjects without subsubjects defined if they were imported flat
                            studentsData.forEach(student => {
                                const markValue = student.marks[sub.key];
                                if (typeof markValue === 'number' || markValue === undefined) {
                                    student.marks[sub.key] = { mark: markValue || 0, subMarks: {} };
                                }
                            });
                        });
                    }

                    if (state.examName !== undefined) {
                        examNameInput.value = state.examName;
                    }
                }
            } catch (e) {
                console.warn("Could not load state from localStorage. Starting fresh.", e);
                localStorage.removeItem(STORAGE_KEY);
            }
        };

        // --- UTILITY AND SETUP FUNCTIONS ---
        
        const initializeListeners = () => {
             // Main Listeners
            excelUploadInput.addEventListener('change', handleFileUpload); 
            photoUploadInput.addEventListener('change', handlePhotoUpload);
            addStudentManuallyBtn.addEventListener('click', addStudentManually);
            examNameInput.addEventListener('input', updateExamDisplay);
            downloadReportBtn.addEventListener('click', downloadReport);
            if (printIndividualReportBtn) {
                 printIndividualReportBtn.addEventListener('click', () => printIndividualReport(selectedStudentId));
            }

            // Table Listeners (Delegate)
            tableBody.addEventListener('change', (e) => {
                if(e.target.classList.contains('table-input') && e.target.dataset.subject) {
                    const studentId = e.target.closest('tr').dataset.studentId;
                    const subject = e.target.dataset.subject;
                    handleMarkChange(studentId, subject, e.target.value);
                }
            });

            // Subject Config Listeners (Delegate)
            subjectConfigInputs.addEventListener('change', (e) => {
                if(e.target.tagName === 'INPUT' && e.target.dataset.key && !e.target.dataset.subKey) {
                    handleMaxMarkChange(e.target.dataset.key, e.target.value);
                }
            });
            
            subjectConfigInputs.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('[data-action="remove-subject"]');
                const manageBtn = e.target.closest('[data-action="manage-subsubjects"]');
                
                if (removeBtn) {
                    const key = removeBtn.dataset.key;
                    removeSubject(key);
                } else if (manageBtn) {
                    currentSubjectKey = manageBtn.dataset.key;
                    openSubSubjectEditor();
                }
            });

            addSubjectBtn.addEventListener('click', addSubject);

            // Subsubject Modal Listeners
            addSubsubjectBtn.addEventListener('click', addSubSubjectConfig);
            closeModalBtn.addEventListener('click', closeSubSubjectEditor);
            subsubjectListDiv.addEventListener('click', handleSubsubjectListClick);
            subsubjectListDiv.addEventListener('change', handleSubsubjectListChange);

            // Report Card Listener (for editing submarks)
            document.getElementById('subsubject-details-container').addEventListener('change', (e) => {
                if(e.target.dataset.subMarkKey && selectedStudentId) {
                    const subjectKey = e.target.dataset.subjectKey;
                    const subKey = e.target.dataset.subMarkKey;
                    handleSubMarkChange(selectedStudentId, subjectKey, subKey, e.target.value);
                }
            });

            // Clear Data Button Logic (Two-click confirmation)
            const clearDataBtn = document.getElementById('clear-data-btn');
            const clearDataPrompt = document.getElementById('clear-data-prompt');
            let confirmationTimeout = null;

            clearDataBtn.addEventListener('click', () => {
                if (clearDataBtn.dataset.confirm === 'true') {
                    localStorage.removeItem(STORAGE_KEY);
                    studentsData = [];
                    subjectsConfig = [
                        { key: 'physics', name: 'Physics', maxMarks: 100, subSubjects: [] },
                        { key: 'chemistry', name: 'Chemistry', maxMarks: 100, subSubjects: [] },
                        { key: 'biology', name: 'Biology', maxMarks: 100, subSubjects: [] }
                    ];
                    examNameInput.value = "First Mid-Term Examination";
                    selectedStudentId = null;
                    refreshAll();

                    clearDataBtn.textContent = 'Data Cleared!';
                    clearDataBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    clearDataBtn.classList.add('bg-green-500');
                    clearDataPrompt.classList.add('hidden');
                    
                    clearTimeout(confirmationTimeout);

                    setTimeout(() => {
                        clearDataBtn.textContent = '🗑️ Clear All Saved Data';
                        clearDataBtn.classList.remove('bg-green-500');
                        clearDataBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                        clearDataBtn.dataset.confirm = 'false';
                    }, 3000);

                } else {
                    clearDataBtn.dataset.confirm = 'true';
                    clearDataBtn.textContent = 'Click to CONFIRM CLEARING!';
                    clearDataPrompt.classList.remove('hidden');

                    confirmationTimeout = setTimeout(() => {
                        clearDataBtn.dataset.confirm = 'false';
                        clearDataBtn.textContent = '🗑️ Clear All Saved Data';
                        clearDataPrompt.classList.add('hidden');
                    }, 5000);
                }
            });
        }

        // --- SUB-SUBJECT EDITOR LOGIC ---

        const openSubSubjectEditor = () => {
            const subject = subjectsConfig.find(s => s.key === currentSubjectKey);
            if (!subject) return;

            currentSubjectNameSpan.textContent = subject.name;
            renderSubsubjectList();
            subsubjectEditorModal.classList.remove('hidden');
        };

        const closeSubSubjectEditor = () => {
            subsubjectEditorModal.classList.add('hidden');
            currentSubjectKey = null;
            refreshAll(); 
        };

        const renderSubsubjectList = () => {
            const subject = subjectsConfig.find(s => s.key === currentSubjectKey);
            if (!subject) return;

            subsubjectListDiv.innerHTML = '';
            
            if (subject.subSubjects.length === 0) {
                 subsubjectListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">No subsubjects defined. Add one below.</p>';
                 return;
            }

            subject.subSubjects.forEach(sub => {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-3 bg-white p-3 rounded-md border';
                item.dataset.subKey = sub.key;

                item.innerHTML = `
                    <input type="text" value="${sub.name}" class="table-input !w-1/2 !text-left !py-1 !px-2 font-medium" data-sub-action="name" data-sub-key="${sub.key}">
                    <input type="number" min="1" value="${sub.maxMarks}" class="table-input !w-20 !py-1 !px-2 text-center" data-sub-action="max" data-sub-key="${sub.key}">
                    <span class="text-xs text-gray-500 flex-shrink-0">Max</span>
                    <button type="button" class="text-red-500 hover:text-red-700 transition-colors ml-auto flex-shrink-0" data-sub-action="remove" data-sub-key="${sub.key}">
                        🗑️
                    </button>
                `;
                subsubjectListDiv.appendChild(item);
            });
        };

        const addSubSubjectConfig = () => {
            const subject = subjectsConfig.find(s => s.key === currentSubjectKey);
            const name = newSubsubjectNameInput.value.trim();
            const max = parseInt(newSubsubjectMaxInput.value, 10);

            if (!subject || !name || isNaN(max) || max < 1) {
                alert('Please enter a valid name and max marks (minimum 1).');
                return;
            }

            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (subject.subSubjects.some(sub => sub.key === key)) {
                alert('Subsubject name already exists for this subject.');
                return;
            }
            
            const newSub = { key, name, maxMarks: max };
            subject.subSubjects.push(newSub);
            
            // Initialize the new submark for all students
            studentsData.forEach(student => {
                if (!student.marks[currentSubjectKey].subMarks) {
                    student.marks[currentSubjectKey].subMarks = {};
                }
                student.marks[currentSubjectKey].subMarks[key] = 0;
            });

            newSubsubjectNameInput.value = '';
            newSubsubjectMaxInput.value = '50';
            
            recalculateSubjectMax(currentSubjectKey);
            renderSubsubjectList();
        };

        const handleSubsubjectListClick = (e) => {
            const removeBtn = e.target.closest('[data-sub-action="remove"]');
            if (removeBtn) {
                const subKeyToRemove = removeBtn.dataset.subKey;
                removeSubSubjectConfig(subKeyToRemove);
            }
        };

        const handleSubsubjectListChange = (e) => {
            const input = e.target.closest('input');
            if (!input) return;

            const subject = subjectsConfig.find(s => s.key === currentSubjectKey);
            const sub = subject.subSubjects.find(s => s.key === input.dataset.subKey);
            if (!sub) return;

            if (input.dataset.subAction === 'name') {
                sub.name = input.value.trim();
                // We don't change the key to avoid breaking student data linkages
            } else if (input.dataset.subAction === 'max') {
                let newMax = parseInt(input.value, 10);
                if (isNaN(newMax) || newMax < 1) newMax = 1;
                sub.maxMarks = newMax;
                input.value = newMax;
                recalculateSubjectMax(currentSubjectKey);
            }
            // No need for immediate refreshAll, as it happens on modal close
        };
        
        const removeSubSubjectConfig = (subKey) => {
            const subject = subjectsConfig.find(s => s.key === currentSubjectKey);
            if (!subject) return;

            subject.subSubjects = subject.subSubjects.filter(sub => sub.key !== subKey);

            // Remove submark data from all students
            studentsData.forEach(student => {
                if (student.marks[currentSubjectKey].subMarks && student.marks[currentSubjectKey].subMarks[subKey] !== undefined) {
                    delete student.marks[currentSubjectKey].subMarks[subKey];
                }
            });

            recalculateSubjectMax(currentSubjectKey);
            renderSubsubjectList();
        };

        const recalculateSubjectMax = (subjectKey) => {
            const subject = subjectsConfig.find(s => s.key === subjectKey);
            if (!subject) return;

            if (subject.subSubjects.length > 0) {
                const newMax = subject.subSubjects.reduce((sum, sub) => sum + sub.maxMarks, 0);
                subject.maxMarks = newMax;
            } 
            
            // Note: If subSubjects is empty, maxMarks is already set to the default or manually entered value, which is fine.
        };


        // --- EXCEL HANDLING FUNCTIONS ---

        const processWorkbook = (workbook) => {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            const jsonSheet = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonSheet.length < 2) {
                console.error('Excel sheet must contain header and at least one row of data.');
                return false;
            }

            const rawHeaders = jsonSheet[0];
            const headers = rawHeaders.map(h => String(h || '').trim().toLowerCase());

            const ID_KEYWORDS = ['id', 'student id', 'roll no', 'reg no', 'student_id'];
            const NAME_KEYWORDS = ['name', 'full name', 'student name', 'candidate name', 'student_name'];
            const STREAM_KEYWORDS = ['stream', 'course', 'discipline'];

            let idIndex = -1;
            let nameIndex = -1;
            let streamIndex = -1;

            headers.forEach((header, index) => {
                const normalizedHeader = header.replace(/[^a-z0-9]/g, '');
                
                if (idIndex === -1 && ID_KEYWORDS.some(keyword => normalizedHeader.includes(keyword.replace(/ /g, '')))) {
                    idIndex = index;
                }
                if (nameIndex === -1 && NAME_KEYWORDS.some(keyword => normalizedHeader.includes(keyword.replace(/ /g, '')))) {
                    nameIndex = index;
                }
                if (streamIndex === -1 && STREAM_KEYWORDS.some(keyword => normalizedHeader.includes(keyword.replace(/ /g, '')))) {
                    streamIndex = index;
                }
            });

            if (idIndex === -1 || nameIndex === -1) {
                alert('Error: Could not automatically detect "ID" and "Name" columns. Please ensure your sheet includes clear headers like "ID", "Student Name", "Roll No", etc.');
                return false;
            }

            if (idIndex === nameIndex) {
                 alert('Error: ID and Name columns were detected as the same column.');
                 return false;
            }
            
            subjectsConfig = [];
            const subjectIndices = [];
            
            headers.forEach((header, index) => {
                if (index !== idIndex && index !== nameIndex && index !== streamIndex) {
                    const name = rawHeaders[index];
                    const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    if (key) {
                        // When loading from Excel, subjects start with no subsubjects
                        subjectsConfig.push({ key, name, maxMarks: 100, subSubjects: [] });
                        subjectIndices.push(index);
                    }
                }
            });
            
            if (subjectsConfig.length === 0) {
                 alert('Error: No subject columns found. Please ensure you have at least one subject column after ID and Name.');
                 return false;
            }

            studentsData = [];
            for (let i = 1; i < jsonSheet.length; i++) {
                const row = jsonSheet[i];
                if (!row || !row[idIndex] || !row[nameIndex]) continue;

                const streamValue = streamIndex !== -1 && row[streamIndex] ? String(row[streamIndex]).trim() : DEFAULT_STREAM;

                const student = {
                    id: String(row[idIndex]).trim(),
                    name: String(row[nameIndex]).trim(),
                    stream: streamValue,
                    marks: {},
                    photoBase64: null 
                };

                subjectIndices.forEach((colIndex, subIndex) => {
                    const subjectKey = subjectsConfig[subIndex]?.key;
                    if (subjectKey) {
                        const mark = Number(row[colIndex]);
                        // When loading flat marks from Excel, store them as a flat mark with no subMarks
                        student.marks[subjectKey] = {
                            mark: isNaN(mark) ? 0 : mark,
                            subMarks: {}
                        };
                    }
                });

                studentsData.push(student);
            }

            if (studentsData.length === 0) {
                 alert('Error: No valid student data rows found after headers.');
                 return false;
            }
            
            selectedStudentId = null;
            return true;
        };
        
        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' }); 
                    
                    if (processWorkbook(workbook)) {
                        refreshAll();
                        event.target.value = '';
                    }
                } catch (error) {
                    console.error('File parsing error:', error);
                    alert('Error reading the file. Please ensure it is a valid Excel file (.xlsx or .xls).');
                }
            };

            reader.readAsArrayBuffer(file);
        };
        
        // --- MANUAL STUDENT ADDITION ---

        const addStudentManually = () => {
            const id = newStudentIdInput.value.trim();
            const name = newStudentNameInput.value.trim();
            const stream = newStudentStreamInput.value;

            if (!id || !name) {
                alert('Please enter both Student ID and Student Name.');
                return;
            }

            if (studentsData.some(s => s.id === id)) {
                alert(`Student ID "${id}" already exists. Please use a unique ID.`);
                return;
            }

            const newMarks = {};
            subjectsConfig.forEach(sub => {
                newMarks[sub.key] = {
                    mark: 0, 
                    subMarks: {}
                };
            });

            const newStudent = {
                id: id,
                name: name,
                stream: stream,
                marks: newMarks,
                photoBase64: null
            };

            studentsData.push(newStudent);

            newStudentIdInput.value = '';
            newStudentNameInput.value = '';

            refreshAll();
            handleRowSelect(id);
        };


        // --- CORE CALCULATIONS AND RENDERING ---

        const updateExamDisplay = () => {
            const examName = examNameInput.value.trim() || 'Exam Results';
            mainExamDisplay.textContent = examName;
            reportExamName.textContent = examName;
            saveState();
        };

        const getGrade = (percentage) => {
            let grade, color;
            if (percentage >= 0.90) { grade = 'A+'; color = 'green'; }
            else if (percentage >= 0.80) { grade = 'A'; color = 'neutral'; }
            else if (percentage >= 0.70) { grade = 'B+'; color = 'neutral'; }
            else if (percentage >= 0.60) { grade = 'B'; color = 'neutral'; }
            else if (percentage >= 0.50) { grade = 'C+'; color = 'neutral'; }
            else if (percentage >= 0.40) { grade = 'C'; color = 'neutral'; }
            else if (percentage >= 0.30) { grade = 'D+'; color = 'neutral'; }
            else { grade = 'F'; color = 'red'; }
            return { grade, color };
        };

        const getGradeColorClasses = (color) => {
            if (color === 'green') return 'bg-green-100 text-green-800';
            if (color === 'red') return 'bg-red-100 text-red-800';
            if (color === 'neutral') return 'bg-indigo-100 text-indigo-800';
            return 'bg-gray-100 text-gray-800';
        };

        const calculateMetrics = (student) => {
            let total = 0;
            let maxTotal = 0;
            const subjectMetrics = {};

            subjectsConfig.forEach(sub => {
                const markData = student.marks[sub.key] || { mark: 0, subMarks: {} };
                let subjectMark = markData.mark || 0;
                let subjectMax = sub.maxMarks;

                if (sub.subSubjects && sub.subSubjects.length > 0) {
                    subjectMark = sub.subSubjects.reduce((sum, s) => {
                        const subMark = markData.subMarks[s.key] || 0;
                        return sum + subMark;
                    }, 0);
                    // Recalculate subjectMax in case it wasn't saved correctly (safety)
                    subjectMax = sub.subSubjects.reduce((sum, s) => sum + s.maxMarks, 0);
                    
                    // Update the student's main mark field
                    markData.mark = subjectMark; 
                }
                
                const percentage = subjectMax > 0 ? subjectMark / subjectMax : 0;
                const { grade, color } = getGrade(percentage);

                subjectMetrics[sub.key] = { mark: subjectMark, maxMarks: subjectMax, percentage, grade, color, subMarks: markData.subMarks };

                total += subjectMark;
                maxTotal += subjectMax;
            });

            const overallPercentage = maxTotal > 0 ? total / maxTotal : 0;
            const { grade: overallGrade, color: overallColor } = getGrade(overallPercentage);

            return { ...student, total, maxTotal, percentage: overallPercentage, grade: overallGrade, color: overallColor, subjectMetrics };
        };
        
        const calculateAllMetrics = () => {
            // Note: This must modify studentsData in place to update the main subject.mark when subsubjects exist.
            return studentsData.map(calculateMetrics);
        };

        const calculateRanks = (studentsWithMetrics) => {
            const percentages = studentsWithMetrics.map(s => s.percentage);
            return studentsWithMetrics.map(student => {
                const rank = percentages.filter(p => p > student.percentage).length + 1;
                return { ...student, rank };
            });
        };

        const renderSubjectConfig = () => {
            subjectConfigInputs.innerHTML = '';
            if (subjectsConfig.length === 0) {
                 subjectConfigInputs.innerHTML = '<p class="text-gray-500 col-span-4">No subjects defined. Add one below or upload an Excel file.</p>';
            }
            subjectsConfig.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'flex flex-col space-y-1 p-3 border border-gray-200 rounded-lg bg-white shadow-sm';

                const isComposite = sub.subSubjects.length > 0;
                const maxInputHtml = isComposite 
                    ? `<span class="font-semibold text-indigo-600">${sub.maxMarks} (Total of Subsubjects)</span>`
                    : `<input type="number" min="1" id="max-${sub.key}" class="table-input !w-full !text-left !py-2 !px-3" value="${sub.maxMarks}" data-key="${sub.key}">`;

                div.innerHTML = `
                    <label class="text-sm font-bold text-gray-700 block mb-1">${sub.name}</label>
                    <div class="flex items-center space-x-2">
                        ${maxInputHtml}
                        <button type="button" class="text-red-500 hover:text-red-700 transition-colors p-1" data-action="remove-subject" data-key="${sub.key}">
                            <span class="text-xl leading-none">🗑️</span>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 text-xs text-gray-500">
                        <span class="flex-grow">${isComposite ? 'Max Marks (Calculated)' : 'Max Marks (Editable)'}</span>
                        <button type="button" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-1 rounded-md font-medium text-xs transition-colors" data-action="manage-subsubjects" data-key="${sub.key}">
                            ${isComposite ? 'Edit Breakdown' : '+ Add Subsubjects'}
                        </button>
                    </div>
                `;
                subjectConfigInputs.appendChild(div);
            });
        };
        
        const removeSubject = (key) => {
            subjectsConfig = subjectsConfig.filter(sub => sub.key !== key);

            studentsData.forEach(student => {
                if (student.marks[key] !== undefined) {
                    delete student.marks[key];
                }
            });
            
            if (selectedStudentId && !studentsData.some(s => s.id === selectedStudentId)) {
                selectedStudentId = null;
            }

            refreshAll();
        };


        const handleMaxMarkChange = (key, value) => {
            let maxMark = parseInt(value, 10);
            if (isNaN(maxMark) || maxMark < 1) maxMark = 100;

            const subject = subjectsConfig.find(s => s.key === key);
            if (subject && subject.subSubjects.length === 0) {
                subject.maxMarks = maxMark;
                refreshAll();
            }
        };

        const renderTableHeaders = () => {
            tableHeadersRow.innerHTML = `
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rank</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stream</th>
            `;
            subjectsConfig.forEach(sub => {
                tableHeadersRow.innerHTML += `
                    <th colspan="2" class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-l border-gray-300">${sub.name} (Max ${sub.maxMarks})</th>
                `;
            });
            tableHeadersRow.innerHTML += `
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-l border-gray-300">Total</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Percent</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Grade</th>
            `;
        };
        
        const renderTable = () => {
            const studentsWithMetrics = calculateAllMetrics();
            const rankedStudents = calculateRanks(studentsWithMetrics);
            rankedStudents.sort((a, b) => a.rank - b.rank);
            
            renderTableHeaders();

            tableBody.innerHTML = '';
            if (rankedStudents.length === 0) {
                const colspanValue = 5 + (subjectsConfig.length * 2) + 2;
                tableBody.innerHTML = `<tr><td colspan="${colspanValue}" class="text-center py-6 text-gray-500">No student data available. Please upload an Excel sheet or manually add students.</td></tr>`;
                return;
            }

            rankedStudents.forEach(student => {
                const row = document.createElement('tr');
                row.className = `cursor-pointer hover:bg-indigo-50 transition-colors ${student.id === selectedStudentId ? 'table-row-selected' : ''}`;
                row.dataset.studentId = student.id;

                let subjectCells = '';
                subjectsConfig.forEach(sub => {
                    const metrics = student.subjectMetrics[sub.key];
                    const mark = metrics.mark;
                    const max = metrics.maxMarks;
                    const gradeClasses = getGradeColorClasses(metrics.color);
                    const hasSubSubjects = sub.subSubjects && sub.subSubjects.length > 0;
                    
                    const markInputHtml = hasSubSubjects
                        ? `<span class="font-medium text-gray-900">${mark}</span>`
                        : `<input type="number" min="0" max="${max}" class="table-input" value="${mark}" data-subject="${sub.key}">`;
                    
                    const inputTitle = hasSubSubjects
                        ? 'To edit, click the student and update subsubject marks on the report card.'
                        : `Enter mark out of ${max}.`;

                    subjectCells += `
                        <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-500 text-center border-l border-gray-100" title="${inputTitle}">
                            ${markInputHtml}
                            ${hasSubSubjects ? '<span class="text-xs text-indigo-500">(Breakdown)</span>' : ''}
                        </td>
                        <td class="px-2 py-3 whitespace-nowrap text-center">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${gradeClasses}">${metrics.grade}</span>
                        </td>
                    `;
                });

                const overallGradeClasses = getGradeColorClasses(student.color);

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap"><span class="font-semibold text-lg">${student.rank}</span></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.id}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${student.stream || DEFAULT_STREAM}</td>
                    ${subjectCells}
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800 text-center border-l border-gray-300">${student.total}/${student.maxTotal}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800 text-center">${(student.percentage * 100).toFixed(2)}%</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${overallGradeClasses}">${student.grade}</span>
                    </td>
                `;
                
                row.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('table-input')) {
                       handleRowSelect(student.id);
                    }
                });
                
                tableBody.appendChild(row);
            });
        };

        const handleRowSelect = (studentId) => {
            selectedStudentId = studentId;
            renderTable();
            renderProgressReport(studentId);
        }

        const handleMarkChange = (studentId, subjectKey, value) => {
            const student = studentsData.find(s => s.id === studentId);
            const subjectConfig = subjectsConfig.find(s => s.key === subjectKey);

            if (student && subjectConfig && subjectConfig.subSubjects.length === 0) {
                const maxMark = subjectConfig.maxMarks || 100;
                let mark = parseInt(value, 10);
                if (isNaN(mark)) mark = 0;
                if (mark < 0) mark = 0;
                if (mark > maxMark) mark = maxMark;

                // Update flat mark
                student.marks[subjectKey].mark = mark;
                
                // Update input value display
                const inputElement = event.target;
                inputElement.value = mark;

                refreshAll();
            }
        };

        const handleSubMarkChange = (studentId, subjectKey, subKey, value) => {
            const student = studentsData.find(s => s.id === studentId);
            const subjectConfig = subjectsConfig.find(s => s.key === subjectKey);
            const subConfig = subjectConfig.subSubjects.find(s => s.key === subKey);

            if (student && subConfig) {
                const maxMark = subConfig.maxMarks;
                let mark = parseInt(value, 10);
                if (isNaN(mark)) mark = 0;
                if (mark < 0) mark = 0;
                if (mark > maxMark) mark = maxMark;

                // Update nested submark
                student.marks[subjectKey].subMarks[subKey] = mark;
                
                // Update the input value display
                event.target.value = mark;

                refreshAll();
            }
        };
        
        const renderSubsubjectDetails = (student, subjectMetrics) => {
            const container = document.getElementById('subsubject-details-container');
            let html = '';
            
            // Filter subjects that have subsubjects defined
            const compositeSubjects = subjectsConfig.filter(sub => sub.subSubjects.length > 0);

            if (compositeSubjects.length > 0) {
                html += '<h3 class="text-lg font-semibold text-gray-800 mb-2">Detailed Subject Breakdown (Edit Marks Here)</h3>';
                compositeSubjects.forEach(sub => {
                    const metrics = subjectMetrics[sub.key];
                    const studentMarkData = student.marks[sub.key] || { subMarks: {} };
                    
                    html += `<div class="p-4 border border-gray-200 rounded-lg mb-4 bg-gray-50">
                        <h4 class="font-bold text-md text-indigo-700 mb-2">${sub.name} (Total: ${metrics.mark}/${metrics.maxMarks})</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">`;

                    sub.subSubjects.forEach(s => {
                        const subMark = studentMarkData.subMarks[s.key] !== undefined ? studentMarkData.subMarks[s.key] : 0;
                        html += `
                            <div class="flex flex-col">
                                <label class="text-xs font-medium text-gray-600">${s.name} (Max ${s.maxMarks})</label>
                                <input type="number" min="0" max="${s.maxMarks}" value="${subMark}" class="table-input !w-full !py-1 !px-2 !text-left" data-subject-key="${sub.key}" data-sub-mark-key="${s.key}">
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                });
            } else {
                 html += '<p class="text-sm text-gray-500 italic">No subjects currently have an internal subsubject breakdown.</p>';
            }

            container.innerHTML = html;
        };


        const renderProgressReport = (studentId) => {
            const studentsWithMetrics = calculateAllMetrics();
            const rankedStudents = calculateRanks(studentsWithMetrics);
            const student = rankedStudents.find(s => s.id === studentId);

            const reportPhotoContainer = document.getElementById('report-photo-container');

            if (!student) {
                reportPlaceholder.classList.remove('hidden');
                reportContent.classList.add('hidden');
                return;
            }

            // --- Photo Display Logic ---
            if (student.photoBase64) {
                reportPhotoContainer.innerHTML = `<img src="${student.photoBase64}" alt="${student.name} Photo" class="student-photo-preview">`;
            } else {
                 // Unicode User Icon (Fallback)
                reportPhotoContainer.innerHTML = `<div class="student-photo-preview default-photo-icon">👤</div>`; 
            }

            reportPlaceholder.classList.add('hidden');
            reportContent.classList.remove('hidden');

            document.getElementById('report-student-name').textContent = student.name;
            document.getElementById('report-student-id').textContent = `ID: ${student.id}`;
            document.getElementById('report-student-stream').textContent = `Stream: ${student.stream || DEFAULT_STREAM}`;
            document.getElementById('report-rank').textContent = `#${student.rank}`;
            document.getElementById('report-total').textContent = `${student.total}/${student.maxTotal}`;
            document.getElementById('report-percentage').textContent = `${(student.percentage * 100).toFixed(2)}%`;
            document.getElementById('report-grade').textContent = student.grade;

            renderSubsubjectDetails(student, student.subjectMetrics);

            const chartData = {
                labels: subjectsConfig.map(sub => sub.name),
                datasets: [{
                    label: 'Marks',
                    data: subjectsConfig.map(sub => student.subjectMetrics[sub.key]?.mark || 0),
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(79, 70, 229, 1)',
                }]
            };

            const maxMarksArray = subjectsConfig.map(sub => sub.maxMarks);
            const maxScore = maxMarksArray.length > 0 ? Math.max(...maxMarksArray) : 100;

            const chartConfig = {
                type: 'radar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            suggestedMin: 0,
                            suggestedMax: maxScore,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                },
                                color: '#374151'
                            },
                            ticks: {
                                backdropColor: 'rgba(255, 255, 255, 0.75)',
                                color: '#4B5563'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                           display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}/${maxMarksArray[context.dataIndex]}`;
                                }
                            }
                        }
                    }
                }
            };
            
            if (progressChart) {
                progressChart.data = chartData;
                progressChart.options.scales.r.suggestedMax = maxScore;
                progressChart.update();
            } else {
                const ctx = document.getElementById('progress-chart').getContext('2d');
                progressChart = new Chart(ctx, chartConfig);
            }
        };

        const addSubject = () => {
            const name = newSubjectNameInput.value.trim();
            if (!name) return;

            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (subjectsConfig.some(sub => sub.key === key)) {
                newSubjectNameInput.value = '';
                newSubjectNameInput.placeholder = 'Subject already exists!';
                setTimeout(() => { newSubjectNameInput.placeholder = 'New Subject Name (e.g., History)'; }, 2000);
                return;
            }

            const newSubject = { key, name, maxMarks: 100, subSubjects: [] };
            subjectsConfig.push(newSubject);
            
            studentsData.forEach(student => {
                 student.marks[key] = { mark: 0, subMarks: {} };
            });
            
            newSubjectNameInput.value = '';
            
            refreshAll();
        };

        const refreshAll = () => {
            updateExamDisplay();
            renderSubjectConfig();
            renderTable();
            renderPhotoManager();
            if (selectedStudentId) {
                renderProgressReport(selectedStudentId);
            } else {
                 reportPlaceholder.classList.remove('hidden');
                 reportContent.classList.add('hidden');
            }
            saveState();
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            initializeListeners();
            refreshAll();
        });

    </script>
</body>
</html>



