import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { Upload, Book, Trash2, Download, Award, User, X, Home } from 'lucide-react';

// --- Global Constants and Utilities ---
const LOGO_URL = 'uploaded:image_0e42ef.jpg-32cc7d4d-3b22-40e9-9324-d4ffe0ff3fd3';
const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const FIREBASE_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const MAIN_DOCUMENT_PATH = `artifacts/${APP_ID}/public/data/grade_sheets/main_sheet`;

// Grade configuration
const GRADE_THRESHOLDS = [
    { min: 90, grade: 'A+', color: 'text-green-600', bg: 'bg-green-50' },
    { min: 80, grade: 'A', color: 'text-gray-800', bg: 'bg-white' },
    { min: 70, grade: 'B+', color: 'text-gray-800', bg: 'bg-white' },
    { min: 60, grade: 'B', color: 'text-gray-800', bg: 'bg-white' },
    { min: 50, grade: 'C+', color: 'text-gray-800', bg: 'bg-white' },
    { min: 40, grade: 'C', color: 'text-gray-800', bg: 'bg-white' },
    { min: 30, grade: 'D+', color: 'text-gray-800', bg: 'bg-white' },
    { min: 0, grade: 'F', color: 'text-red-600', bg: 'bg-red-50' },
];

/**
 * Calculates the grade and applies color based on the percentage score.
 */
const calculateGrade = (score, maxMarks) => {
    if (maxMarks === 0) return { grade: '-', color: 'text-gray-500', bg: 'bg-gray-100' };
    const percentage = (score / maxMarks) * 100;
    const { grade, color, bg } = GRADE_THRESHOLDS.find(t => percentage >= t.min) || GRADE_THRESHOLDS[GRADE_THRESHOLDS.length - 1];
    return { grade, color, bg };
};

// --- Initial Data Structure ---
const initialData = {
    institution: {
        name: 'Ifer Academy',
        logoUrl: LOGO_URL,
        address: 'Better Education Better Society',
    },
    examName: 'Annual Examination 2025',
    subjects: [
        { id: 'math', name: 'Mathematics', maxMarks: 100, subSubjects: [] },
        { id: 'phy', name: 'Physics', maxMarks: 70, subSubjects: [{ name: 'Theory', maxMarks: 50 }, { name: 'Practical', maxMarks: 20 }] },
        { id: 'chem', name: 'Chemistry', maxMarks: 100, subSubjects: [] },
    ],
    students: [
        // Example student data structure
        {
            id: crypto.randomUUID(),
            name: 'Akash K.',
            stream: 'Biology Science',
            photoUrl: '',
            marks: {
                math: { score: 95, subScores: {} },
                phy: { score: 65, subScores: { 'Theory': 48, 'Practical': 17 } },
                chem: { score: 82, subScores: {} },
            }
        },
    ],
};

// --- Main App Component ---
export default function App() {
    const [data, setData] = useState(initialData);
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isLoading, setIsLoading] = useState(true);
    const [view, setView] = useState('sheet'); // 'sheet', 'config', 'report'
    const [selectedStudentId, setSelectedStudentId] = useState(null);
    const [message, setMessage] = useState('');

    // --- Firebase Initialization and Data Sync ---
    useEffect(() => {
        if (Object.keys(FIREBASE_CONFIG).length === 0) {
            console.error("Firebase config is missing.");
            setIsLoading(false);
            return;
        }

        try {
            const app = initializeApp(FIREBASE_CONFIG);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);
            setDb(firestoreDb);
            setAuth(firebaseAuth);

            // 1. Authenticate (initial auth token or anonymous)
            const signIn = async () => {
                try {
                    if (AUTH_TOKEN) {
                        await signInWithCustomToken(firebaseAuth, AUTH_TOKEN);
                    } else {
                        await signInAnonymously(firebaseAuth);
                    }
                } catch (error) {
                    console.error("Firebase Authentication failed:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    await signInAnonymously(firebaseAuth).catch(err => console.error("Anonymous sign-in failed:", err));
                }
            };
            signIn();

            // 2. Auth State Listener
            onAuthStateChanged(firebaseAuth, (user) => {
                const currentUserId = user?.uid || crypto.randomUUID();
                setUserId(currentUserId);
                setIsAuthReady(true);
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setIsLoading(false);
        }
    }, []);

    // 3. Data Sync Listener (onSnapshot)
    useEffect(() => {
        if (db && isAuthReady) {
            const docRef = doc(db, MAIN_DOCUMENT_PATH);

            const unsubscribe = onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const savedData = docSnapshot.data();
                    setData(prev => ({ ...prev, ...savedData }));
                    console.log("Data loaded from Firestore.");
                } else {
                    console.log("No data found, using initial state.");
                }
                setIsLoading(false);
            }, (error) => {
                console.error("Error reading Firestore data:", error);
                setIsLoading(false);
            });

            return () => unsubscribe();
        }
    }, [db, isAuthReady]);

    // --- Data Persistence ---
    const saveData = useCallback(async (currentData) => {
        if (!db) {
            console.warn("Database not ready.");
            return;
        }
        try {
            const docRef = doc(db, MAIN_DOCUMENT_PATH);
            await setDoc(docRef, currentData, { merge: true });
            setMessage('Data saved successfully!');
            setTimeout(() => setMessage(''), 3000);
        } catch (error) {
            console.error("Error saving data to Firestore:", error);
            setMessage('Error saving data!');
            setTimeout(() => setMessage(''), 3000);
        }
    }, [db]);

    // Use a throttle or debounce in a real app, but for this context, save on every significant change
    const updateData = useCallback((newData) => {
        setData(newData);
        saveData(newData);
    }, [saveData]);

    // --- Core Logic: Calculation & Ranking ---
    const processedStudents = useMemo(() => {
        if (!data.students || data.students.length === 0) return [];

        const studentsWithTotals = data.students.map(student => {
            let totalScore = 0;
            let totalMaxMarks = 0;

            // Calculate total score and max marks across all configured subjects
            data.subjects.forEach(subject => {
                const studentMark = student.marks[subject.id];
                if (studentMark && studentMark.score !== undefined && studentMark.score !== null) {
                    totalScore += studentMark.score;
                    totalMaxMarks += subject.maxMarks;
                }
            });

            const percentage = totalMaxMarks > 0 ? (totalScore / totalMaxMarks) * 100 : 0;

            return {
                ...student,
                totalScore,
                totalMaxMarks,
                percentage: parseFloat(percentage.toFixed(2)),
            };
        });

        // 2. Rank calculation (Overall Rank based on total score)
        const sortedStudents = studentsWithTotals
            .sort((a, b) => b.totalScore - a.totalScore) // Sort descending by total score
            .map((student, index) => ({
                ...student,
                rank: index + 1
            }));

        return sortedStudents;
    }, [data.students, data.subjects]);

    // --- Handlers for Configuration ---

    const handleInstDetailsChange = (key, value) => {
        const newData = { ...data, institution: { ...data.institution, [key]: value } };
        updateData(newData);
    };

    const handleSubjectChange = (id, key, value) => {
        const updatedSubjects = data.subjects.map(sub =>
            sub.id === id ? { ...sub, [key]: key === 'maxMarks' ? parseInt(value) || 0 : value } : sub
        );
        updateData({ ...data, subjects: updatedSubjects });
    };

    const addSubject = () => {
        const newId = crypto.randomUUID().slice(0, 8);
        const newSubject = { id: newId, name: `New Subject ${data.subjects.length + 1}`, maxMarks: 100, subSubjects: [] };
        updateData({ ...data, subjects: [...data.subjects, newSubject] });
    };

    const removeSubject = (id) => {
        const updatedSubjects = data.subjects.filter(sub => sub.id !== id);
        // Also remove marks for this subject from all students
        const updatedStudents = data.students.map(student => {
            const { [id]: _, ...restMarks } = student.marks;
            return { ...student, marks: restMarks };
        });
        updateData({ ...data, subjects: updatedSubjects, students: updatedStudents });
    };

    // Sub-subject handlers (simplified)
    const addSubSubject = (subjectId) => {
        const updatedSubjects = data.subjects.map(sub => {
            if (sub.id === subjectId) {
                const newSub = { name: `Sub-Topic ${sub.subSubjects.length + 1}`, maxMarks: 50 };
                return { ...sub, subSubjects: [...sub.subSubjects, newSub] };
            }
            return sub;
        });
        updateData({ ...data, subjects: updatedSubjects });
    };

    const removeSubSubject = (subjectId, subName) => {
        const updatedSubjects = data.subjects.map(sub => {
            if (sub.id === subjectId) {
                return { ...sub, subSubjects: sub.subSubjects.filter(ss => ss.name !== subName) };
            }
            return sub;
        });
        updateData({ ...data, subjects: updatedSubjects });
    };

    // --- Handlers for Student Data ---

    const addStudent = () => {
        const newId = crypto.randomUUID();
        const newStudent = {
            id: newId,
            name: `New Student ${data.students.length + 1}`,
            stream: 'Computer Science',
            photoUrl: '',
            marks: data.subjects.reduce((acc, sub) => ({
                ...acc,
                [sub.id]: { score: null, subScores: {} }
            }), {})
        };
        updateData({ ...data, students: [...data.students, newStudent] });
    };

    const removeStudent = (id) => {
        const updatedStudents = data.students.filter(s => s.id !== id);
        updateData({ ...data, students: updatedStudents });
    };

    const handleMarkChange = (studentId, subjectId, value) => {
        const score = parseInt(value) || null;
        const updatedStudents = data.students.map(student => {
            if (student.id === studentId) {
                return {
                    ...student,
                    marks: {
                        ...student.marks,
                        [subjectId]: {
                            ...student.marks[subjectId],
                            score: score
                        }
                    }
                };
            }
            return student;
        });
        updateData({ ...data, students: updatedStudents });
    };

    const handleSubMarkChange = (studentId, subjectId, subName, value) => {
        const subScore = parseInt(value) || null;
        const updatedStudents = data.students.map(student => {
            if (student.id === studentId) {
                const currentSubject = student.marks[subjectId] || { score: null, subScores: {} };
                const updatedSubScores = { ...currentSubject.subScores, [subName]: subScore };

                // Calculate total score from sub-scores
                const totalScore = Object.values(updatedSubScores).reduce((sum, s) => sum + (s || 0), 0);

                return {
                    ...student,
                    marks: {
                        ...student.marks,
                        [subjectId]: {
                            score: totalScore, // Auto-update total score
                            subScores: updatedSubScores
                        }
                    }
                };
            }
            return student;
        });
        updateData({ ...data, students: updatedStudents });
    };

    // Photo/Stream/Name Update
    const handleStudentDetailsChange = (studentId, key, value) => {
        const updatedStudents = data.students.map(student => {
            if (student.id === studentId) {
                return { ...student, [key]: value };
            }
            return student;
        });
        updateData({ ...data, students: updatedStudents });
    };

    const uploadStudentPhoto = (studentId, file) => {
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            handleStudentDetailsChange(studentId, 'photoUrl', reader.result);
        };
        reader.readAsDataURL(file);
    };

    // --- Excel Upload Handler (Simplified) ---
    const handleExcelUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (typeof window.XLSX === 'undefined') {
            alert('Excel parser library (XLSX) is not loaded. Please ensure the environment supports external scripts.');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const bstr = e.target.result;
            const workbook = window.XLSX.read(bstr, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (json.length < 2) return;

            const header = json[0].map(h => String(h).trim());
            const rows = json.slice(1);

            const nameIndex = header.findIndex(h => h.toLowerCase() === 'name');
            const streamIndex = header.findIndex(h => h.toLowerCase() === 'stream');

            if (nameIndex === -1) {
                alert("Excel must contain a column titled 'Name'.");
                return;
            }

            const newStudents = rows.map(row => {
                const studentId = crypto.randomUUID();
                const studentName = row[nameIndex] || `Unnamed Student ${studentId.slice(0, 4)}`;
                const studentStream = streamIndex !== -1 ? row[streamIndex] : 'Computer Science';
                let studentMarks = {};

                data.subjects.forEach(subject => {
                    const subjectIndex = header.findIndex(h => h.toLowerCase() === subject.name.toLowerCase());
                    let score = null;
                    if (subjectIndex !== -1) {
                        const rawScore = parseFloat(row[subjectIndex]);
                        score = isNaN(rawScore) ? null : rawScore;
                    }
                    studentMarks[subject.id] = { score: score, subScores: {} };
                });

                return {
                    id: studentId,
                    name: studentName,
                    stream: studentStream,
                    photoUrl: '',
                    marks: studentMarks
                };
            });

            updateData({ ...data, students: newStudents });
            alert(`Successfully imported ${newStudents.length} students. Ensure Max Marks are configured.`);
        };
        reader.readAsBinaryString(file);
    };

    // --- Download Handlers (PDF & Excel) ---

    // A utility function to convert a DOM element to PDF
    const downloadPDF = (elementId, filename) => {
        if (typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
            alert('PDF generation libraries (html2canvas/jspdf) are not loaded. Download will not work.');
            return;
        }
        const input = document.getElementById(elementId);
        if (!input) {
            console.error(`Element with id ${elementId} not found.`);
            return;
        }

        window.html2canvas(input, { scale: 2 }).then((canvas) => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(filename);
        });
    };

    const downloadFullExcel = () => {
        if (typeof window.XLSX === 'undefined') {
            alert('Excel parser library (XLSX) is not loaded. Download will not work.');
            return;
        }

        const wsData = [
            ['INSTITUTION:', data.institution.name, 'EXAMINATION:', data.examName],
            ['', '', '', ''],
            ['RANK', 'NAME', 'STREAM', ...data.subjects.map(s => s.name), 'TOTAL SCORE', 'TOTAL MAX', 'PERCENTAGE']
        ];

        processedStudents.forEach(s => {
            const studentRow = [
                s.rank,
                s.name,
                s.stream,
                ...data.subjects.map(sub => s.marks[sub.id]?.score ?? ''),
                s.totalScore,
                s.totalMaxMarks,
                s.percentage + '%'
            ];
            wsData.push(studentRow);
        });

        const ws = window.XLSX.utils.aoa_to_sheet(wsData);
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, "Grade Sheet");
        window.XLSX.writeFile(wb, `${data.examName}_Grade_Sheet.xlsx`);
    };

    const downloadIndividualReportPDF = (student) => {
        setSelectedStudentId(student.id);
        setView('report');
        setTimeout(() => { // Wait for the modal/view to render
            downloadPDF('individual-report-container', `${student.name}_${data.examName}_Report.pdf`);
            setView('sheet');
            setSelectedStudentId(null);
        }, 100);
    };

    // --- Loading State UI ---
    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-xl font-semibold text-blue-600">Loading data and connecting to server...</div>
            </div>
        );
    }

    // --- View Components ---

    const ReportModal = ({ student }) => {
        if (!student) return null;

        const { totalScore, totalMaxMarks, percentage, rank } = student;
        const overallGrade = calculateGrade(totalScore, totalMaxMarks);

        return (
            <div className="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
                <div id="individual-report-container" className="bg-white rounded-lg shadow-2xl w-full max-w-3xl p-8 transform transition-all duration-300 relative">
                    <button
                        className="absolute top-4 right-4 text-gray-500 hover:text-gray-900"
                        onClick={() => { setView('sheet'); setSelectedStudentId(null); }}
                    >
                        <X size={24} />
                    </button>

                    {/* Header */}
                    <div className="flex items-center justify-between border-b pb-4 mb-4">
                        <div className="flex items-center">
                            <img src={data.institution.logoUrl} alt="Logo" className="w-16 h-16 mr-4 rounded-full object-cover" />
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">{data.institution.name}</h2>
                                <p className="text-sm text-gray-500">{data.institution.address}</p>
                            </div>
                        </div>
                        <h3 className="text-xl font-semibold text-blue-600">{data.examName}</h3>
                    </div>

                    {/* Student Info */}
                    <div className="flex justify-between items-start my-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="space-y-1">
                            <p className="text-lg font-bold">Student: <span className="text-blue-700">{student.name}</span></p>
                            <p>Stream: <span className="font-medium">{student.stream}</span></p>
                            <p>Roll No (ID): <span className="font-mono text-sm">{student.id}</span></p>
                        </div>
                        {student.photoUrl && (
                            <img src={student.photoUrl} alt="Student" className="w-24 h-24 object-cover rounded-full shadow-md" />
                        )}
                    </div>

                    {/* Marks Table */}
                    <h4 className="text-xl font-semibold mt-6 mb-3 border-b pb-1">Subject Performance</h4>
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Score</th>
                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Max Marks</th>
                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Grade</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                            {data.subjects.map(subject => {
                                const mark = student.marks[subject.id];
                                const score = mark?.score ?? 0;
                                const max = subject.maxMarks;
                                const { grade, color, bg } = calculateGrade(score, max);

                                return (
                                    <React.Fragment key={subject.id}>
                                        <tr className={`${bg} hover:bg-gray-100 transition-colors`}>
                                            <td className="px-3 py-2 font-medium">{subject.name}</td>
                                            <td className="px-3 py-2 text-center">{score}</td>
                                            <td className="px-3 py-2 text-center">{max}</td>
                                            <td className={`px-3 py-2 text-center font-bold ${color}`}>{grade}</td>
                                        </tr>
                                        {subject.subSubjects.length > 0 && mark?.subScores && (
                                            subject.subSubjects.map(subSub => (
                                                <tr key={subSub.name} className="text-xs italic bg-gray-50">
                                                    <td className="px-6 py-1">-- {subSub.name}</td>
                                                    <td className="px-3 py-1 text-center">{mark.subScores[subSub.name] ?? 0}</td>
                                                    <td className="px-3 py-1 text-center">{subSub.maxMarks}</td>
                                                    <td className="px-3 py-1 text-center"></td>
                                                </tr>
                                            ))
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </tbody>
                    </table>

                    {/* Summary */}
                    <div className="mt-6 border-t pt-4 grid grid-cols-3 gap-4">
                        <div className="p-3 bg-indigo-50 rounded-lg text-center shadow-inner">
                            <p className="text-sm text-indigo-700">Total Marks</p>
                            <p className="text-2xl font-extrabold text-indigo-900">{totalScore} / {totalMaxMarks}</p>
                        </div>
                        <div className="p-3 bg-purple-50 rounded-lg text-center shadow-inner">
                            <p className="text-sm text-purple-700">Percentage</p>
                            <p className="text-2xl font-extrabold text-purple-900">{percentage}%</p>
                        </div>
                        <div className="p-3 bg-yellow-50 rounded-lg text-center shadow-inner">
                            <p className="text-sm text-yellow-700">Overall Rank</p>
                            <p className="text-2xl font-extrabold text-yellow-900">{rank} <Award className="inline h-6 w-6" /></p>
                        </div>
                    </div>

                    <div className={`mt-4 p-3 rounded-lg text-center font-bold text-xl ${overallGrade.bg} ${overallGrade.color}`}>
                        Overall Grade: {overallGrade.grade}
                    </div>

                    <p className="mt-6 text-xs text-gray-500 text-center">-- Generated by {data.institution.name} System --</p>
                </div>
            </div>
        );
    };

    const ConfigurationView = () => (
        <div className="p-4 space-y-8 max-w-4xl mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">Institution & Examination Setup</h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-xl shadow-inner">
                {/* Institution Details */}
                <div className="space-y-4">
                    <h3 className="text-xl font-semibold text-blue-600">Institution Details</h3>
                    <input
                        type="text"
                        placeholder="Institution Name"
                        className="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        value={data.institution.name}
                        onChange={(e) => handleInstDetailsChange('name', e.target.value)}
                    />
                    <input
                        type="text"
                        placeholder="Institution Address/Motto"
                        className="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        value={data.institution.address}
                        onChange={(e) => handleInstDetailsChange('address', e.target.value)}
                    />
                    <div className="flex items-center space-x-2">
                        <img src={data.institution.logoUrl} alt="Logo" className="w-10 h-10 rounded-full object-cover shadow" />
                        <span className="text-sm text-gray-500">Logo URL: {data.institution.logoUrl}</span>
                    </div>
                </div>

                {/* Examination Details */}
                <div className="space-y-4">
                    <h3 className="text-xl font-semibold text-blue-600">Examination Details</h3>
                    <input
                        type="text"
                        placeholder="Examination Name"
                        className="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        value={data.examName}
                        onChange={(e) => updateData({ ...data, examName: e.target.value })}
                    />
                </div>
            </div>

            {/* Subject Management */}
            <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mt-8">Subject Management</h2>
            <div className="space-y-4">
                {data.subjects.map((subject, index) => (
                    <div key={subject.id} className="p-4 border border-blue-200 rounded-xl bg-white shadow-sm">
                        <div className="flex items-center space-x-3 mb-2">
                            <input
                                type="text"
                                placeholder="Subject Name"
                                className="flex-1 p-2 border rounded-lg font-semibold"
                                value={subject.name}
                                onChange={(e) => handleSubjectChange(subject.id, 'name', e.target.value)}
                            />
                            <input
                                type="number"
                                placeholder="Max Marks"
                                className="w-32 p-2 border rounded-lg text-center"
                                value={subject.maxMarks}
                                onChange={(e) => handleSubjectChange(subject.id, 'maxMarks', e.target.value)}
                            />
                            <button
                                className="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors"
                                onClick={() => removeSubject(subject.id)}
                            >
                                <Trash2 size={20} />
                            </button>
                        </div>

                        {/* Sub-Subjects (Optional) */}
                        <div className="pl-4 border-l-2 border-dashed border-gray-300">
                            {subject.subSubjects.map((subSub, ssIndex) => (
                                <div key={ssIndex} className="flex items-center space-x-2 text-sm mt-1">
                                    <span className="text-gray-600 w-24 overflow-hidden text-ellipsis whitespace-nowrap">{subSub.name}</span>
                                    <span className="text-gray-400">({subSub.maxMarks})</span>
                                    <button
                                        className="text-red-400 hover:text-red-600"
                                        onClick={() => removeSubSubject(subject.id, subSub.name)}
                                    >
                                        <X size={14} />
                                    </button>
                                </div>
                            ))}
                            <button
                                className="mt-2 text-xs text-blue-500 hover:text-blue-700 font-medium"
                                onClick={() => addSubSubject(subject.id)}
                            >
                                + Add Sub-Subject
                            </button>
                        </div>
                    </div>
                ))}
            </div>

            <button
                className="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-lg flex items-center justify-center space-x-2"
                onClick={addSubject}
            >
                <Book size={20} />
                <span>Add New Subject</span>
            </button>
        </div>
    );

    const MarkSheetView = () => (
        <div className="p-4">
            <div className="flex items-center justify-between mb-6 border-b pb-3">
                <div>
                    <h2 className="text-3xl font-bold text-gray-800">{data.institution.name}</h2>
                    <p className="text-lg text-blue-600">{data.examName} - Grade Sheet</p>
                </div>
                <button
                    className="p-3 bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600 transition-colors flex items-center space-x-2"
                    onClick={downloadFullExcel}
                >
                    <Download size={20} />
                    <span>Download Marksheet (Excel)</span>
                </button>
            </div>

            {/* Student Data Input & Import Section */}
            <div className="bg-white p-4 rounded-xl shadow-lg mb-6">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-semibold text-gray-700">Student & Data Management</h3>
                    <button
                        className="py-2 px-4 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors flex items-center space-x-1"
                        onClick={addStudent}
                    >
                        <User size={18} />
                        <span>Add Student</span>
                    </button>
                </div>
                <div className="flex space-x-4">
                    <label className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg cursor-pointer hover:bg-gray-300 transition-colors flex items-center justify-center space-x-2 shadow-inner">
                        <Upload size={18} />
                        <span>Upload Marks (Excel)</span>
                        <input type="file" accept=".xlsx, .xls" className="hidden" onChange={handleExcelUpload} />
                    </label>
                </div>
            </div>

            {/* Main Grade Sheet Table */}
            <div className="overflow-x-auto bg-white rounded-xl shadow-lg">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-blue-600 text-white sticky top-0">
                        <tr>
                            <th className="py-3 px-3 text-center text-sm font-bold uppercase">Rank</th>
                            <th className="py-3 px-3 text-left text-sm font-bold uppercase w-48">Student Name (ID: {userId.slice(0, 8)})</th>
                            <th className="py-3 px-3 text-left text-sm font-bold uppercase">Stream</th>
                            {data.subjects.map(subject => (
                                <th key={subject.id} className="py-3 px-2 text-center text-sm font-bold uppercase min-w-[100px] whitespace-nowrap">
                                    {subject.name} ({subject.maxMarks})
                                </th>
                            ))}
                            <th className="py-3 px-3 text-center text-sm font-bold uppercase bg-gray-700">Total</th>
                            <th className="py-3 px-3 text-center text-sm font-bold uppercase bg-gray-700">Percent</th>
                            <th className="py-3 px-3 text-center text-sm font-bold uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {processedStudents.map(student => {
                            const { rank, totalScore, totalMaxMarks, percentage } = student;
                            const overallGrade = calculateGrade(totalScore, totalMaxMarks);
                            return (
                                <tr key={student.id} className="hover:bg-blue-50 transition-colors">
                                    <td className="py-3 px-3 text-center font-bold text-lg text-blue-700">{rank}</td>
                                    <td className="py-3 px-3 whitespace-nowrap">
                                        <input
                                            type="text"
                                            value={student.name}
                                            onChange={(e) => handleStudentDetailsChange(student.id, 'name', e.target.value)}
                                            className="w-full p-1 border-b border-dashed focus:border-solid rounded-md bg-transparent"
                                        />
                                        <select
                                            value={student.stream}
                                            onChange={(e) => handleStudentDetailsChange(student.id, 'stream', e.target.value)}
                                            className="mt-1 text-xs text-gray-500 bg-transparent border-0 focus:ring-0 p-0 w-full"
                                        >
                                            <option>Biology Science</option>
                                            <option>Computer Science</option>
                                            <option>Commerce</option>
                                        </select>
                                    </td>
                                    <td className="py-3 px-3 text-left text-sm">{student.stream}</td>
                                    {/* Subject Scores */}
                                    {data.subjects.map(subject => {
                                        const mark = student.marks[subject.id];
                                        const score = mark?.score ?? '';
                                        const gradeInfo = calculateGrade(score, subject.maxMarks);

                                        return (
                                            <td key={subject.id} className={`py-1 px-1 text-center font-medium ${gradeInfo.bg}`}>
                                                <input
                                                    type="number"
                                                    value={score}
                                                    onChange={(e) => handleMarkChange(student.id, subject.id, e.target.value)}
                                                    className={`w-full p-1 text-center font-bold ${gradeInfo.color} bg-transparent border-b border-gray-300 focus:border-blue-500`}
                                                    placeholder="-"
                                                    min="0"
                                                    max={subject.maxMarks}
                                                />
                                                <span className={`text-xs block ${gradeInfo.color}`}>{gradeInfo.grade}</span>

                                                {/* Sub-Subjects Input (Simplified) */}
                                                {subject.subSubjects.length > 0 && (
                                                    <div className="text-xs text-gray-500 mt-1 space-y-0.5">
                                                        {subject.subSubjects.map(subSub => (
                                                            <input
                                                                key={subSub.name}
                                                                type="number"
                                                                placeholder={subSub.name.slice(0, 4)}
                                                                value={mark?.subScores[subSub.name] ?? ''}
                                                                onChange={(e) => handleSubMarkChange(student.id, subject.id, subSub.name, e.target.value)}
                                                                className="w-1/2 p-0.5 text-center border-b focus:border-blue-500 bg-gray-50"
                                                                min="0"
                                                                max={subSub.maxMarks}
                                                            />
                                                        ))}
                                                    </div>
                                                )}
                                            </td>
                                        );
                                    })}
                                    {/* Calculated Totals */}
                                    <td className="py-3 px-3 text-center font-extrabold bg-gray-700 text-white">{totalScore}</td>
                                    <td className={`py-3 px-3 text-center font-extrabold ${overallGrade.color} bg-gray-700 text-white`}>
                                        {percentage}%
                                    </td>
                                    {/* Actions */}
                                    <td className="py-3 px-3 flex flex-col space-y-1">
                                        <button
                                            className="text-xs py-1 px-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                                            onClick={() => downloadIndividualReportPDF(student)}
                                        >
                                            Report (PDF)
                                        </button>
                                        <label className="text-xs py-1 px-2 bg-gray-200 text-gray-700 rounded-lg cursor-pointer hover:bg-gray-300 text-center">
                                            Photo
                                            <input type="file" accept="image/*" className="hidden" onChange={(e) => uploadStudentPhoto(student.id, e.target.files[0])} />
                                        </label>
                                        <button
                                            className="text-xs py-1 px-2 text-red-600 hover:bg-red-100 rounded-lg"
                                            onClick={() => removeStudent(student.id)}
                                        >
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            <div className="mt-4 p-4 bg-yellow-100 border border-yellow-300 rounded-lg">
                <p className="font-semibold text-yellow-800">Note on Excel Import:</p>
                <p className="text-sm text-yellow-700">The Excel file must have a column named **'Name'** and optionally **'Stream'**. Subject scores are matched by subject name (e.g., a column named 'Mathematics' will map to the 'Mathematics' subject).</p>
            </div>
        </div>
    );

    // --- Main Layout ---
    const studentForReport = processedStudents.find(s => s.id === selectedStudentId);

    return (
        <div className="min-h-screen bg-gray-100 font-sans">
            {/* Header / Navigation */}
            <header className="sticky top-0 z-10 bg-white shadow-lg p-4 flex justify-between items-center">
                <div className="flex items-center space-x-4">
                    <img src={data.institution.logoUrl} alt="Logo" className="w-8 h-8 rounded-full" />
                    <h1 className="text-xl font-extrabold text-blue-800 hidden sm:block">Grade System</h1>
                </div>
                <nav className="flex space-x-4">
                    <button
                        className={`py-2 px-4 rounded-lg font-medium transition-colors flex items-center space-x-1 ${view === 'sheet' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}
                        onClick={() => setView('sheet')}
                    >
                        <Home size={18} /> <span>Mark Sheet</span>
                    </button>
                    <button
                        className={`py-2 px-4 rounded-lg font-medium transition-colors flex items-center space-x-1 ${view === 'config' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}
                        onClick={() => setView('config')}
                    >
                        <Book size={18} /> <span>Configuration</span>
                    </button>
                </nav>
            </header>

            {/* Status Message */}
            {message && (
                <div className="p-3 text-center bg-green-200 text-green-800 font-semibold transition-opacity duration-500">
                    {message}
                </div>
            )}

            {/* Content Area */}
            <main className="pb-12">
                {view === 'sheet' && <MarkSheetView />}
                {view === 'config' && <ConfigurationView />}
            </main>

            {/* Individual Report Modal (Rendered only when needed) */}
            {(view === 'report' && selectedStudentId && studentForReport) && (
                <ReportModal student={studentForReport} />
            )}
        </div>
    );
}







